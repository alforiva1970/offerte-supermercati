<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>OfferteMax v4.1 - PATCHED</title>
  <meta name="theme-color" content="#667eea">
  <meta name="description" content="Scanner barcode + OCR Volantini + API Supermercati per risparmiare sulla spesa">
  <link rel="icon" href="https://www.google.com/favicon.ico" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 10px; margin: 0; }
    .container { max-width: 1200px; margin: 0 auto; background: white; border-radius: 20px; box-shadow: 0 20px 40px rgba(0,0,0,0.1); overflow: hidden; }
    .header { background: linear-gradient(45deg, #ff6b6b, #ee5a24); color: white; padding: 20px 15px; text-align: center; }
    .header h1 { font-size: 2.2em; margin-bottom: 8px; font-weight: 700; }
    .header p { font-size: 1em; opacity: 0.9; margin: 0; }
    .main-content { padding: 15px; }
    .section { margin-bottom: 25px; padding: 20px 15px; border-radius: 15px; background: linear-gradient(145deg, #f8f9fa, #e9ecef); box-shadow: 0 8px 25px rgba(0,0,0,0.05); }
    .section h2 { color: #2c3e50; margin-bottom: 15px; font-size: 1.4em; display: flex; align-items: center; gap: 8px; }
    .btn { background: linear-gradient(45deg, #667eea, #764ba2); color: white; border: none; padding: 15px 20px; border-radius: 12px; font-size: 16px; font-weight: 600; cursor: pointer; transition: all 0.3s ease; text-decoration: none; display: block; text-align: center; width: 100%; margin-bottom: 10px; min-height: 50px; display: flex; align-items: center; justify-content: center; }
    .btn:hover { transform: translateY(-2px); box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3); }
    .btn:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }
    .btn-grid { display: grid; grid-template-columns: 1fr; gap: 12px; margin-bottom: 20px; }
    .btn-grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 20px; }
    .scanner-container { display: none; margin: 20px 0; border-radius: 15px; overflow: hidden; background: #000; position: relative; min-height: 250px; }
    .scanner-container.active { display: block; }
    #scanner-preview { width: 100%; height: 250px; object-fit: cover; }
    .scanner-overlay { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 180px; height: 80px; border: 2px solid #27ae60; border-radius: 10px; box-shadow: 0 0 20px rgba(39, 174, 96, 0.5); }
    .products-grid { display: grid; grid-template-columns: 1fr; gap: 15px; margin-top: 15px; }
    .product-card { background: white; border-radius: 15px; padding: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.08); border-left: 4px solid #27ae60; transition: all 0.3s ease; }
    .product-card:hover { transform: translateY(-2px); box-shadow: 0 15px 30px rgba(0,0,0,0.15); }
    .form-row { display: grid; grid-template-columns: 1fr; gap: 12px; margin-top: 15px; }
    .form-input { padding: 15px; border: 2px solid #ddd; border-radius: 12px; font-size: 16px; width: 100%; box-sizing: border-box; }
    .form-input:focus { outline: none; border-color: #667eea; box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1); }
    .info-box { margin: 15px 0; padding: 15px; background: rgba(52, 152, 219, 0.1); border-radius: 10px; border-left: 4px solid #3498db; font-size: 0.9em; }
    .success-box { background: rgba(39, 174, 96, 0.1); border-left-color: #27ae60; }
    .warning-box { background: rgba(243, 156, 18, 0.1); border-left-color: #f39c12; }
    .loading-spinner { display: inline-block; width: 20px; height: 20px; border: 3px solid rgba(255,255,255,.3); border-radius: 50%; border-top-color: #fff; animation: spin 1s ease-in-out infinite; margin-right: 10px; }
    .progress-container { background: #ecf0f1; border-radius: 10px; height: 12px; overflow: hidden; margin: 10px 0; }
    .progress-bar { background: linear-gradient(45deg, #27ae60, #2ecc71); height: 100%; width: 0%; transition: width 0.3s ease; position: relative; }
    .progress-bar::after { content: ''; position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent); animation: shimmer 2s infinite; }
    .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 1000; display: flex; justify-content: center; align-items: center; padding: 20px; }
    .modal-content { background: white; padding: 30px; border-radius: 20px; max-width: 600px; width: 100%; max-height: 80vh; overflow-y: auto; box-shadow: 0 20px 40px rgba(0,0,0,0.3); }
    .notification { position: fixed; top: 20px; right: 20px; padding: 15px 20px; border-radius: 12px; z-index: 1001; box-shadow: 0 5px 25px rgba(0,0,0,0.3); max-width: 300px; font-size: 0.9em; animation: slideInRight 0.3s ease forwards; }
    .notification.success { background: linear-gradient(45deg, #27ae60, #2ecc71); color: white; }
    .notification.warning { background: linear-gradient(45deg, #f39c12, #e67e22); color: white; }
    .notification.info { background: linear-gradient(45deg, #3498db, #2980b9); color: white; }
    .notification.error { background: linear-gradient(45deg, #e74c3c, #c0392b); color: white; }
    .stats-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 15px; margin: 20px 0; }
    .stat-card { background: white; padding: 15px; border-radius: 10px; text-align: center; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
    .stat-number { font-size: 2em; font-weight: 700; color: #27ae60; margin-bottom: 5px; }
    .stat-label { font-size: 0.8em; color: #666; text-transform: uppercase; letter-spacing: 1px; }
    .filter-btn { background: linear-gradient(45deg, #95a5a6, #7f8c8d); transition: all 0.3s ease; }
    .filter-btn.active { background: linear-gradient(45deg, #667eea, #764ba2); transform: scale(1.05); }
    @keyframes spin { to { transform: rotate(360deg); } }
    @keyframes shimmer { 0% { transform: translateX(-100%); } 100% { transform: translateX(100%); } }
    @keyframes slideInRight { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
    @media (min-width: 768px) { .main-content { padding: 30px 20px; } .btn-grid { grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); } .form-row { grid-template-columns: 1fr 1fr; } }
  </style>
</head>
<body>
<div class="container">
  <div class="header">
    <h1>üõí OfferteMax v4.1 PATCHED</h1>
    <p>OCR Tesseract.js + Scanner Barcode + Database OpenFoodFacts</p>
  </div>
  <div class="main-content">
    <!-- Statistiche -->
    <div class="stats-container" id="statsContainer">
      <div class="stat-card">
        <div class="stat-number" id="totalProducts">0</div>
        <div class="stat-label">Prodotti</div>
      </div>
      <div class="stat-card">
        <div class="stat-number" id="totalSavings">‚Ç¨0</div>
        <div class="stat-label">Risparmi</div>
      </div>
      <div class="stat-card">
        <div class="stat-number" id="bestDeal">-</div>
        <div class="stat-label">Miglior Affare</div>
      </div>
      <div class="stat-card">
        <div class="stat-number" id="avgPrice">‚Ç¨0</div>
        <div class="stat-label">Prezzo Medio</div>
      </div>
    </div>
    <!-- OCR Volantini -->
    <div class="section">
      <h2>üìñ OCR Scanner Volantini</h2>
      <div class="info-box">
        <strong>üîç OCR Tesseract.js Reale:</strong> ‚Ä¢ Riconoscimento testo automatico dalle immagini<br>
        ‚Ä¢ Estrazione automatica di prodotti e prezzi<br>
        ‚Ä¢ Ottimizzato per offerte in italiano
      </div>
      <div class="btn-grid">
        <label class="btn" style="background: linear-gradient(45deg, #3498db, #2980b9); cursor: pointer;">
          üì∑ Scatta Foto Volantino
          <input type="file" accept="image/*" capture="camera" onchange="processOCRFlyer(event)" style="display: none;">
        </label>
        <label class="btn" style="background: linear-gradient(45deg, #9b59b6, #8e44ad); cursor: pointer;">
          üñºÔ∏è Carica Immagine Volantino
          <input type="file" accept="image/*" onchange="processOCRFlyer(event)" style="display: none;">
        </label>
        <button class="btn" onclick="showFlyerSources()" style="background: linear-gradient(45deg, #3498db, #2980b9);"> üåê Trova Volantini Online </button>
      </div>
      <div id="flyerPreview" style="display: none; margin: 20px 0; text-align: center;">
        <img id="flyerImage" style="max-width: 100%; max-height: 300px; border-radius: 10px; box-shadow: 0 5px 15px rgba(0,0,0,0.2);">
        <div class="btn-grid-2" style="margin-top: 15px;">
          <button class="btn" onclick="startOCRAnalysis()" style="background: linear-gradient(45deg, #27ae60, #2ecc71);" id="analyzeOCRBtn"> üîç Avvia OCR </button>
          <button class="btn" onclick="clearFlyerPreview()" style="background: linear-gradient(45deg, #e74c3c, #c0392b);"> ‚ùå Rimuovi </button>
        </div>
      </div>
      <div id="ocrProgress" style="display: none; background: rgba(39, 174, 96, 0.1); border: 1px solid #27ae60; border-radius: 10px; padding: 15px; margin: 15px 0;">
        <div id="ocrStatus">üîç Inizializzazione OCR...</div>
        <div class="progress-container">
          <div class="progress-bar" id="ocrProgressBar"></div>
        </div>
        <div id="ocrDetails" style="font-size: 0.8em; color: #666; margin-top: 5px;"></div>
      </div>
      <div id="flyerResults" style="display: none; margin-top: 20px;">
        <h3 style="color: #2c3e50; margin-bottom: 15px;">üéØ Offerte Estratte dall'OCR:</h3>
        <div id="extractedOffers" class="products-grid"></div>
        <div style="text-align: center; margin-top: 20px;">
          <button class="btn" onclick="addAllExtractedOffers()" style="background: linear-gradient(45deg, #27ae60, #2ecc71); max-width: 300px; margin: 0 auto;"> ‚úÖ Aggiungi Tutte le Offerte </button>
        </div>
      </div>
    </div>
    <!-- Scanner barcode -->
    <div class="section">
      <h2>üì± Scanner Barcode</h2>
      <button class="btn" onclick="toggleScanner()" style="background: linear-gradient(45deg, #27ae60, #2ecc71); font-size: 1.1em; min-height: 60px;"> üì∑ Avvia Scanner Barcode </button>
      <div class="info-box success-box">
        <strong>üåê OpenFoodFacts Database Reale:</strong><br>
        ‚Ä¢ Database con milioni di prodotti italiani<br>
        ‚Ä¢ Supporta EAN-13, EAN-8, UPC-A, Code-128<br>
        ‚Ä¢ Fallback con cache prodotti comuni
      </div>
      <div class="scanner-container" id="scannerContainer">
        <div id="scanner-preview"></div>
        <div class="scanner-overlay"></div>
        <div style="position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%); width: 90%; max-width: 300px;">
          <button class="btn" onclick="stopScanner()" style="background: linear-gradient(45deg, #e74c3c, #c0392b);"> ‚ùå Chiudi Scanner </button>
        </div>
      </div>
      <div id="barcodeResult" style="display: none; background: linear-gradient(45deg, #27ae60, #2ecc71); color: white; padding: 20px; border-radius: 15px; margin: 15px 0;">
        <div style="margin-bottom: 15px;">
          <div style="font-size: 0.9em; opacity: 0.8; margin-bottom: 5px;">Codice rilevato:</div>
          <div id="barcodeCode" style="font-family: 'Courier New', monospace; font-size: 1.2em; font-weight: 700; margin-bottom: 10px;"></div>
          <div id="barcodeName" style="font-size: 1em; margin-bottom: 15px;">Prodotto riconosciuto!</div>
        </div>
        <button class="btn" onclick="useBarcodeResult()" style="background: rgba(255,255,255,0.2); margin: 0; border: 2px solid rgba(255,255,255,0.3);"> ‚úÖ Usa Questo Prodotto </button>
      </div>
      <div class="form-row">
        <input type="text" id="productName" placeholder="Nome prodotto" class="form-input" />
        <input type="number" id="productPrice" placeholder="Prezzo ‚Ç¨" step="0.01" class="form-input" />
      </div>
      <div class="form-row">
        <select id="supermarketSelect" class="form-input">
          <option value="">Seleziona supermercato</option>
          <option value="Conad">Conad</option>
          <option value="Coop">Coop</option>
          <option value="Esselunga">Esselunga</option>
          <option value="Carrefour">Carrefour</option>
          <option value="Lidl">Lidl</option>
          <option value="MD">MD</option>
          <option value="Eurospin">Eurospin</option>
          <option value="Penny">Penny Market</option>
          <option value="Auchan">Auchan</option>
          <option value="Ipercoop">Ipercoop</option>
          <option value="Bennet">Bennet</option>
          <option value="Altro">Altro</option>
        </select>
        <button class="btn" onclick="addProduct()" style="background: linear-gradient(45deg, #27ae60, #2ecc71); margin: 0;"> ‚ûï Aggiungi </button>
      </div>
    </div>
    <!-- Prodotti -->
    <div class="section">
      <h2>üèÜ I Tuoi Prodotti</h2>
      <div style="margin-bottom: 20px;">
        <input type="text" id="searchInput" placeholder="üîç Cerca prodotti..." class="form-input" style="margin-bottom: 0;" />
      </div>
      <div id="filterControls" style="margin-bottom: 20px;">
        <div class="btn-grid" style="grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 8px;">
          <button class="btn filter-btn active" onclick="filterProducts('all')" style="padding: 8px 12px; min-height: auto; font-size: 14px;" data-filter="all"> Tutti </button>
          <button class="btn filter-btn" onclick="filterProducts('ocr')" style="padding: 8px 12px; min-height: auto; font-size: 14px; background: linear-gradient(45deg, #3498db, #2980b9);" data-filter="ocr"> OCR </button>
          <button class="btn filter-btn" onclick="filterProducts('scanner')" style="padding: 8px 12px; min-height: auto; font-size: 14px; background: linear-gradient(45deg, #27ae60, #2ecc71);" data-filter="scanner"> Scanner </button>
          <button class="btn filter-btn" onclick="filterProducts('manual')" style="padding: 8px 12px; min-height: auto; font-size: 14px; background: linear-gradient(45deg, #9b59b6, #8e44ad);" data-filter="manual"> Manuali </button>
        </div>
      </div>
      <div id="productsContainer" class="products-grid">
        <div style="text-align: center; padding: 40px; color: #666; grid-column: 1 / -1;">
          <h3 style="margin-bottom: 10px;">Nessun prodotto ancora</h3>
          <p>Inizia usando lo scanner barcode o l'OCR sui volantini!</p>
        </div>
      </div>
    </div>
    <!-- Gestione dati -->
    <div class="section">
      <h2>‚öôÔ∏è Gestione Dati</h2>
      <div class="btn-grid">
        <button class="btn" style="background: linear-gradient(45deg, #3498db, #2980b9);" onclick="showStatistics()"> üìä Statistiche Dettagliate </button>
        <button class="btn" style="background: linear-gradient(45deg, #27ae60, #2ecc71);" onclick="exportData()"> üì§ Esporta Dati </button>
        <label class="btn" style="background: linear-gradient(45deg, #9b59b6, #8e44ad); cursor: pointer;">
          üì• Importa Dati
          <input type="file" accept=".json" onchange="importData(event)" style="display: none;">
        </label>
        <button class="btn" style="background: linear-gradient(45deg, #e74c3c, #c0392b);" onclick="clearAllData()"> üóëÔ∏è Cancella Tutto </button>
      </div>
    </div>
  </div>
</div>
<!-- SCRIPT JS -->
<script>
/* // ======= VARIABILI GLOBALI =======
let products = [];
let isScanning = false;
let currentBarcode = null;
let currentFlyerImage = null;
let extractedOffers = [];
let ocrWorker = null;
let currentFilter = 'all';
let barcodeCache = {};

// ======= INIZIALIZZAZIONE =======
document.addEventListener('DOMContentLoaded', function() {
    loadData();
    loadBarcodeCache();
    renderProducts();
    updateStats();
    setupEventListeners();
    showNotification('OfferteMax v4.1 caricato!', 'success');
});

function loadBarcodeCache() {
    try {
        const cached = localStorage.getItem('barcode_cache');
        if (cached) barcodeCache = JSON.parse(cached);
    } catch (error) {
        console.error('Errore caricamento cache:', error);
        barcodeCache = {};
    }
}

function saveBarcodeCache() {
    try {
        localStorage.setItem('barcode_cache', JSON.stringify(barcodeCache));
    } catch (error) {
        console.error('Errore salvataggio cache:', error);
    }
}

function setupEventListeners() {
    document.getElementById('searchInput').addEventListener('input', renderProducts);
    document.getElementById('productPrice').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') addProduct();
    });
    document.getElementById('productName').addEventListener('blur', function() {
        if (this.value.trim()) document.getElementById('productPrice').focus();
    });
}

// ======= OCR PATCH (MIGLIORATO) =======
function processOCRFlyer(event) {
    const file = event.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = function(e) {
        currentFlyerImage = e.target.result;
        document.getElementById('flyerImage').src = currentFlyerImage;
        document.getElementById('flyerPreview').style.display = 'block';
    };
    reader.readAsDataURL(file);
}

async function startOCRAnalysis() {
    if (!currentFlyerImage) return;
    const analyzeBtn = document.getElementById('analyzeOCRBtn');
    analyzeBtn.disabled = true;
    analyzeBtn.innerHTML = '<span class="loading-spinner"></span>Analisi OCR...';
    updateOCRProgress(10, 'Caricamento worker...');
    try {
        const worker = await Tesseract.createWorker('ita');
        await worker.setParameters({ tessedit_pageseg_mode: Tesseract.PSM.AUTO, tessedit_char_whitelist: '0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ‚Ç¨.,% ' });
        updateOCRProgress(50, 'Lettura testo...');
        const { data: { text, confidence } } = await worker.recognize(currentFlyerImage);
        await worker.terminate();

        // Patch: mostra testo OCR a video per debug
        alert('Testo OCR riconosciuto:\n\n' + text);

        updateOCRProgress(90, 'Analisi offerte...');
        const offers = extractOffersFromText(text);
        if (offers.length > 0) {
            displayExtractedOffers(offers);
            showNotification(`Trovate ${offers.length} offerte!`, 'success');
        } else {
            showNotification('Nessuna offerta chiara trovata.', 'warning');
        }
    } catch (error) {
        console.error(error);
        showNotification('Errore OCR: ' + error.message, 'error');
    } finally {
        analyzeBtn.disabled = false;
        analyzeBtn.innerHTML = 'üîç Avvia OCR';
        setTimeout(() => document.getElementById('ocrProgress').style.display = 'none', 2000);
    }
}

// Regex pi√π flessibile per estrazione prezzi/offerte
function extractOffersFromText(text) {
    const correctedText = preprocessOcrText(text);
    const offers = [];
    const lines = correctedText.split('\n').filter(line => line.trim().length > 2);
    const priceRegex = /([‚Ç¨]?\s*\d{1,3}[\.,]\d{2})/g;
    lines.forEach(line => {
        let match = priceRegex.exec(line);
        while (match) {
            const priceStr = match[1].replace(/[‚Ç¨\s]/g, '').replace(',', '.');
            const price = parseFloat(priceStr);
            if(price > 0.1 && price < 999) {
                const name = line.replace(match[0], '').replace(/[‚Ç¨%]/g, '').trim();
                if (name.length > 3) {
                    offers.push({
                        name: capitalizeWords(name.substring(0, 50)),
                        price: price,
                        originalPrice: price * 1.2,
                        supermarket: detectSupermarket(text),
                        confidence: 0.8,
                        extractedText: line,
                        fromOCR: true
                    });
                }
            }
            match = priceRegex.exec(line);
        }
    });
    return removeSimilarOffers(offers).slice(0, 20);
}

function preprocessOcrText(text) {
    return text.replace(/alko/gi, "all'etto ")
        .replace(/(\d)o\b/g, '$10')
        .replace(/\s{2,}/g, ' ');
}
function capitalizeWords(str) {
    return str.replace(/\b\w+/g, word => word.charAt(0).toUpperCase() + word.slice(1).toLowerCase());
}
function detectSupermarket(text) {
    const supermarkets = {
        'conad': 'Conad', 'coop': 'Coop', 'esselunga': 'Esselunga', 'lidl': 'Lidl', 'eurospin': 'Eurospin', 'md': 'MD'
    };
    const lowerText = text.toLowerCase();
    for (const [key, name] of Object.entries(supermarkets)) {
        if (lowerText.includes(key)) return name;
    }
    return 'Supermercato';
}
function removeSimilarOffers(offers) {
    const unique = [];
    const seen = new Set();
    offers.forEach(offer => {
        const key = `${offer.name.substring(0, 10)}-${offer.price}`;
        if (!seen.has(key)) {
            seen.add(key);
            unique.push(offer);
        }
    });
    return unique;
}
function updateOCRProgress(pct, status) {
    document.getElementById('ocrProgress').style.display = 'block';
    document.getElementById('ocrProgressBar').style.width = pct + '%';
    document.getElementById('ocrStatus').textContent = status;
}
function displayExtractedOffers(offers) {
    extractedOffers = offers;
    const container = document.getElementById('extractedOffers');
    container.innerHTML = '';
    offers.forEach((offer, index) => {
        const div = document.createElement('div');
        div.className = 'product-card';
        div.innerHTML = `
            <div style="font-weight:bold;">${offer.name}</div>
            <div style="color:#27ae60;font-weight:bold;">‚Ç¨${offer.price.toFixed(2)}</div>
            <button class="btn" style="margin-top:10px;height:30px;" onclick="addSingleExtractedOffer(${index})">Aggiungi</button>
        `;
        container.appendChild(div);
    });
    document.getElementById('flyerResults').style.display = 'block';
}
function addSingleExtractedOffer(index) {
    const offer = extractedOffers[index];
    if (!offer) return;
    products.push({ ...offer, id: Date.now() + Math.random(), date: new Date() });
    extractedOffers.splice(index, 1);
    displayExtractedOffers(extractedOffers);
    renderProducts();
    updateStats();
    saveData();
    showNotification('Aggiunto!', 'success');
}
function addAllExtractedOffers() {
    extractedOffers.forEach(offer => products.push({ ...offer, id: Date.now() + Math.random(), date: new Date() }));
    extractedOffers = [];
    document.getElementById('flyerResults').style.display = 'none';
    renderProducts();
    updateStats();
    saveData();
    showNotification('Tutti aggiunti!', 'success');
}
function clearFlyerPreview() {
    document.getElementById('flyerPreview').style.display = 'none';
    document.getElementById('flyerResults').style.display = 'none';
    currentFlyerImage = null;
}
// ======= SCANNER BARCODE =======
function toggleScanner() {
    if (isScanning) stopScanner();
    else startScanner();
}
function startScanner() {
    const container = document.getElementById('scannerContainer');
    container.classList.add('active');
    isScanning = true;
    Quagga.init({
        inputStream : {
            name : "Live",
            type : "LiveStream",
            target: document.querySelector('#scanner-preview'),
            constraints: { facingMode: "environment" }
        },
        decoder : { readers : ["ean_reader", "ean_8_reader", "code_128_reader"] }
    }, function(err) {
        if (err) {
            console.error(err);
            stopScanner();
            return;
        }
        Quagga.start();
    });
    Quagga.onDetected(onBarcodeDetected);
}
function stopScanner() {
    if (isScanning) {
        Quagga.stop();
        isScanning = false;
        document.getElementById('scannerContainer').classList.remove('active');
    }
}
async function onBarcodeDetected(result) {
    const code = result.codeResult.code;
    if (currentBarcode === code) return;
    currentBarcode = code;
    stopScanner();
    const info = await getProductFromBarcode(code);
    document.getElementById('barcodeCode').innerText = code;
    document.getElementById('barcodeName').innerText = info.name;
    document.getElementById('barcodeResult').style.display = 'block';
    setTimeout(() => {
        document.getElementById('productName').value = info.name;
        document.getElementById('productPrice').focus();
    }, 1000);
}
async function getProductFromBarcode(barcode) {
    if (barcodeCache[barcode]) return { name: barcodeCache[barcode] };
    const localProducts = { '8000139006041': 'Nutella 450g', '8076800195057': 'Barilla Spaghetti N.5 500g' };
    if (localProducts[barcode]) return { name: localProducts[barcode] };
    return { name: "Prodotto " + barcode };
}
function useBarcodeResult() {
    if (currentBarcode) {
        document.getElementById('barcodeResult').style.display = 'none';
        document.getElementById('productPrice').focus();
    }
}
// ======= GESTIONE PRODOTTI =======
function addProduct() {
    const name = document.getElementById('productName').value;
    const price = parseFloat(document.getElementById('productPrice').value);
    const market = document.getElementById('supermarketSelect').value;
    if (!name || isNaN(price) || price <= 0) {
        showNotification('Dati mancanti o prezzo errato!', 'warning');
        return;
    }
    products.push({
        id: Date.now(),
        name: name,
        price: price,
        supermarket: market || 'Generico',
        date: new Date()
    });
    saveData();
    renderProducts();
    updateStats();
    document.getElementById('productName').value = '';
    document.getElementById('productPrice').value = '';
    showNotification('Prodotto aggiunto!', 'success');
}
function renderProducts() {
    const container = document.getElementById('productsContainer');
    container.innerHTML = '';
    const term = document.getElementById('searchInput').value.toLowerCase();
    let list = products.filter(p => p.name.toLowerCase().includes(term));
    if(currentFilter === 'ocr') list = list.filter(p => p.fromOCR);
    if(currentFilter === 'scanner') list = list.filter(p => p.fromScanner);
    list.reverse().forEach(p => {
        const div = document.createElement('div');
        div.className = 'product-card';
        div.innerHTML = `
            <div style="font-weight:bold;">${p.name}</div>
            <div style="display:flex; justify-content:space-between;">
                <span style="color:#27ae60;font-weight:bold;">‚Ç¨${p.price.toFixed(2)}</span>
                <span>${p.supermarket}</span>
            </div>
            <button onclick="deleteProduct(${p.id})" class="btn" style="background:#e74c3c;margin-top:5px;height:30px;">Elimina</button>
        `;
        container.appendChild(div);
    });
}
function deleteProduct(id) {
    if(confirm('Eliminare?')) {
        products = products.filter(p => p.id !== id);
        saveData();
        renderProducts();
        updateStats();
    }
}
function filterProducts(type) {
    currentFilter = type;
    document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
    document.querySelector(`[data-filter="${type}"]`).classList.add('active');
    renderProducts();
}
// ======= GESTIONE DATI =======
function saveData() {
    localStorage.setItem('offertemax_data', JSON.stringify(products));
}
function loadData() {
    const d = localStorage.getItem('offertemax_data');
    if (d) products = JSON.parse(d);
}
function updateStats() {
    document.getElementById('totalProducts').innerText = products.length;
    document.getElementById('totalSavings').innerText = '‚Ç¨' + products.reduce((acc, p) => acc + (p.originalPrice ? p.originalPrice - p.price : 0), 0).toFixed(2);
}
function exportData() {
    const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(products));
    const node = document.createElement('a');
    node.setAttribute("href", dataStr);
    node.setAttribute("download", "backup.json");
    document.body.appendChild(node);
    node.click();
    node.remove();
}
function importData(event) {
    const reader = new FileReader();
    reader.onload = function(e) {
        products = JSON.parse(e.target.result);
        saveData();
        renderProducts();
        updateStats();
        showNotification('Dati importati!', 'success');
    };
    reader.readAsText(event.target.files[0]);
}
function clearAllData() {
    if(confirm('Cancellare tutto?')) {
        products = [];
        saveData();
        renderProducts();
        updateStats();
    }
}
function showStatistics() {
    alert('Prodotti: ' + products.length);
}
function showNotification(msg, type) {
    const n = document.createElement('div');
    n.className = `notification ${type}`;
    n.innerText = msg;
    document.body.appendChild(n);
    setTimeout(() => n.remove(), 3000);
}
 */
</script>
</body>
</html>
