<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OfferteMax v4.1 - OCR Reale + Scanner Avanzato</title>
    <meta name="theme-color" content="#667eea">
    <meta name="description" content="Scanner barcode + OCR Volantini + API Supermercati per risparmiare sulla spesa">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js"></script>
    <script src='https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js'></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 10px;
            margin: 0;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(45deg, #ff6b6b, #ee5a24);
            color: white;
            padding: 20px 15px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 2.2em;
            margin-bottom: 8px;
            font-weight: 700;
        }
        
        .header p {
            font-size: 1em;
            opacity: 0.9;
            margin: 0;
        }
        
        .main-content {
            padding: 15px;
        }
        
        .section {
            margin-bottom: 25px;
            padding: 20px 15px;
            border-radius: 15px;
            background: linear-gradient(145deg, #f8f9fa, #e9ecef);
            box-shadow: 0 8px 25px rgba(0,0,0,0.05);
        }
        
        .section h2 {
            color: #2c3e50;
            margin-bottom: 15px;
            font-size: 1.4em;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .btn {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 15px 20px;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: block;
            text-align: center;
            width: 100%;
            margin-bottom: 10px;
            min-height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }
        
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        
        .btn-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 12px;
            margin-bottom: 20px;
        }
        
        .btn-grid-2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .scanner-container {
            display: none;
            margin: 20px 0;
            border-radius: 15px;
            overflow: hidden;
            background: #000;
            position: relative;
            min-height: 250px;
        }
        
        .scanner-container.active {
            display: block;
        }
        
        #scanner-preview {
            width: 100%;
            height: 250px;
            object-fit: cover;
        }
        
        .scanner-overlay {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 180px;
            height: 80px;
            border: 2px solid #27ae60;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(39, 174, 96, 0.5);
        }
        
        .products-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 15px;
            margin-top: 15px;
        }
        
        .product-card {
            background: white;
            border-radius: 15px;
            padding: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
            border-left: 4px solid #27ae60;
            transition: all 0.3s ease;
        }
        
        .product-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 15px 30px rgba(0,0,0,0.15);
        }
        
        .form-row {
            display: grid;
            grid-template-columns: 1fr;
            gap: 12px;
            margin-top: 15px;
        }
        
        .form-input {
            padding: 15px;
            border: 2px solid #ddd;
            border-radius: 12px;
            font-size: 16px;
            width: 100%;
            box-sizing: border-box;
        }
        
        .form-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .info-box {
            margin: 15px 0;
            padding: 15px;
            background: rgba(52, 152, 219, 0.1);
            border-radius: 10px;
            border-left: 4px solid #3498db;
            font-size: 0.9em;
        }
        
        .success-box {
            background: rgba(39, 174, 96, 0.1);
            border-left-color: #27ae60;
        }
        
        .warning-box {
            background: rgba(243, 156, 18, 0.1);
            border-left-color: #f39c12;
        }
        
        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
            margin-right: 10px;
        }

        .progress-container {
            background: #ecf0f1;
            border-radius: 10px;
            height: 12px;
            overflow: hidden;
            margin: 10px 0;
        }

        .progress-bar {
            background: linear-gradient(45deg, #27ae60, #2ecc71);
            height: 100%;
            width: 0%;
            transition: width 0.3s ease;
            position: relative;
        }

        .progress-bar::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
            animation: shimmer 2s infinite;
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.6);
            z-index: 1000;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 20px;
            max-width: 600px;
            width: 100%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 20px 40px rgba(0,0,0,0.3);
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 12px;
            z-index: 1001;
            box-shadow: 0 5px 25px rgba(0,0,0,0.3);
            max-width: 300px;
            font-size: 0.9em;
            animation: slideInRight 0.3s ease forwards;
        }

        .notification.success {
            background: linear-gradient(45deg, #27ae60, #2ecc71);
            color: white;
        }

        .notification.warning {
            background: linear-gradient(45deg, #f39c12, #e67e22);
            color: white;
        }

        .notification.info {
            background: linear-gradient(45deg, #3498db, #2980b9);
            color: white;
        }

        .notification.error {
            background: linear-gradient(45deg, #e74c3c, #c0392b);
            color: white;
        }

        .stats-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .stat-card {
            background: white;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        .stat-number {
            font-size: 2em;
            font-weight: 700;
            color: #27ae60;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 0.8em;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .filter-btn {
            background: linear-gradient(45deg, #95a5a6, #7f8c8d);
            transition: all 0.3s ease;
        }

        .filter-btn.active {
            background: linear-gradient(45deg, #667eea, #764ba2);
            transform: scale(1.05);
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }

        @keyframes slideInRight {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        @keyframes slideOutRight {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(100%); opacity: 0; }
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        
        @media (min-width: 480px) {
            .btn-grid-2 {
                grid-template-columns: 1fr 1fr;
            }
            
            .form-row {
                grid-template-columns: 2fr 1fr;
            }
            
            .form-row.three-cols {
                grid-template-columns: 2fr 1fr 1fr;
            }
        }
        
        @media (min-width: 768px) {
            .container {
                margin: 20px auto;
            }
            
            .main-content {
                padding: 30px 20px;
            }
            
            .section {
                padding: 25px;
                margin-bottom: 40px;
            }
            
            .header {
                padding: 30px 20px;
            }
            
            .header h1 {
                font-size: 2.5em;
                margin-bottom: 10px;
            }
            
            .btn-grid {
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            }
            
            .btn-grid-2 {
                grid-template-columns: 1fr 1fr;
            }
            
            .products-grid {
                grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
                gap: 20px;
            }
            
            .form-row {
                grid-template-columns: 1fr 1fr;
            }
            
            .form-row.four-cols {
                grid-template-columns: 2fr 1fr 2fr 1fr;
            }

            #scanner-preview {
                height: 350px;
            }

            .scanner-container {
                min-height: 350px;
            }

            .scanner-overlay {
                width: 220px;
                height: 120px;
            }
        }

        @media (max-width: 480px) {
            .header h1 {
                font-size: 1.8em;
            }
            
            .section h2 {
                font-size: 1.2em;
            }
            
            .btn {
                font-size: 14px;
                padding: 12px 15px;
            }
            
            .notification {
                right: 10px;
                top: 10px;
                max-width: calc(100vw - 20px);
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üõí OfferteMax v4.1</h1>
            <p>OCR Tesseract.js Reale + Scanner Barcode + Database OpenFoodFacts</p>
        </div>
        
        <div class="main-content">
            <!-- STATISTICHE RAPIDE -->
            <div class="stats-container" id="statsContainer">
                <div class="stat-card">
                    <div class="stat-number" id="totalProducts">0</div>
                    <div class="stat-label">Prodotti</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="totalSavings">‚Ç¨0</div>
                    <div class="stat-label">Risparmi</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="bestDeal">-</div>
                    <div class="stat-label">Miglior Affare</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="avgPrice">‚Ç¨0</div>
                    <div class="stat-label">Prezzo Medio</div>
                </div>
            </div>

            <!-- SEZIONE OCR VOLANTINI -->
            <div class="section">
                <h2>üìñ OCR Scanner Volantini</h2>
                
                <div class="info-box">
                    <strong>üîç OCR Tesseract.js Reale:</strong><br>
                    ‚Ä¢ Riconoscimento testo automatico dalle immagini<br>
                    ‚Ä¢ Estrazione automatica di prodotti e prezzi<br>
                    ‚Ä¢ Supporta volantini JPG, PNG e documenti PDF<br>
                    ‚Ä¢ Ottimizzato per offerte in italiano
                </div>
                
                <div class="btn-grid">
                    <label class="btn" style="background: linear-gradient(45deg, #3498db, #2980b9); cursor: pointer;">
                        üì∑ Scatta Foto Volantino
                        <input type="file" accept="image/*" capture="camera" onchange="processOCRFlyer(event)" style="display: none;">
                    </label>
                    <label class="btn" style="background: linear-gradient(45deg, #9b59b6, #8e44ad); cursor: pointer;">
                        üñºÔ∏è Carica Immagine Volantino
                        <input type="file" accept="image/*" onchange="processOCRFlyer(event)" style="display: none;">
                    </label>
                    <button class="btn" onclick="showFlyerSources()" style="background: linear-gradient(45deg, #3498db, #2980b9);">
                        üåê Trova Volantini Online
                    </button>
                </div>
                
                <div id="flyerPreview" style="display: none; margin: 20px 0; text-align: center;">
                    <img id="flyerImage" style="max-width: 100%; max-height: 300px; border-radius: 10px; box-shadow: 0 5px 15px rgba(0,0,0,0.2);">
                    <div class="btn-grid-2" style="margin-top: 15px;">
                        <button class="btn" onclick="startOCRAnalysis()" style="background: linear-gradient(45deg, #27ae60, #2ecc71);" id="analyzeOCRBtn">
                            üîç Avvia OCR
                        </button>
                        <button class="btn" onclick="clearFlyerPreview()" style="background: linear-gradient(45deg, #e74c3c, #c0392b);">
                            ‚ùå Rimuovi
                        </button>
                    </div>
                </div>
                
                <div id="ocrProgress" style="display: none; background: rgba(39, 174, 96, 0.1); border: 1px solid #27ae60; border-radius: 10px; padding: 15px; margin: 15px 0;">
                    <div id="ocrStatus">üîç Inizializzazione OCR...</div>
                    <div class="progress-container">
                        <div class="progress-bar" id="ocrProgressBar"></div>
                    </div>
                    <div id="ocrDetails" style="font-size: 0.8em; color: #666; margin-top: 5px;"></div>
                </div>
                
                <div id="ocrTextDisplay" style="display: none; background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 8px; padding: 15px; margin: 15px 0; max-height: 200px; overflow-y: auto; font-family: 'Courier New', monospace; font-size: 0.9em; white-space: pre-wrap;"></div>
                
                <div id="flyerResults" style="display: none; margin-top: 20px;">
                    <h3 style="color: #2c3e50; margin-bottom: 15px;">üéØ Offerte Estratte dall'OCR:</h3>
                    <div id="extractedOffers" class="products-grid"></div>
                    <div style="text-align: center; margin-top: 20px;">
                        <button class="btn" onclick="addAllExtractedOffers()" style="background: linear-gradient(45deg, #27ae60, #2ecc71); max-width: 300px; margin: 0 auto;">
                            ‚úÖ Aggiungi Tutte le Offerte
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- SEZIONE SCANNER BARCODE -->
            <div class="section">
                <h2>üì± Scanner Barcode</h2>
                
                <button class="btn" onclick="toggleScanner()" style="background: linear-gradient(45deg, #27ae60, #2ecc71); font-size: 1.1em; min-height: 60px;">
                    üì∑ Avvia Scanner Barcode
                </button>
                
                <div class="info-box success-box">
                    <strong>üåê OpenFoodFacts Database Reale:</strong><br>
                    ‚Ä¢ Database con milioni di prodotti italiani<br>
                    ‚Ä¢ Riconoscimento automatico via CORS proxy<br>
                    ‚Ä¢ Supporta EAN-13, EAN-8, UPC-A, Code-128<br>
                    ‚Ä¢ Fallback con cache prodotti comuni
                </div>
                
                <div class="scanner-container" id="scannerContainer">
                    <div id="scanner-preview"></div>
                    <div class="scanner-overlay"></div>
                    <div style="position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%); width: 90%; max-width: 300px;">
                        <button class="btn" onclick="stopScanner()" style="background: linear-gradient(45deg, #e74c3c, #c0392b);">
                            ‚ùå Chiudi Scanner
                        </button>
                    </div>
                </div>
                
                <div id="barcodeResult" style="display: none; background: linear-gradient(45deg, #27ae60, #2ecc71); color: white; padding: 20px; border-radius: 15px; margin: 15px 0;">
                    <div style="margin-bottom: 15px;">
                        <div style="font-size: 0.9em; opacity: 0.8; margin-bottom: 5px;">Codice rilevato:</div>
                        <div id="barcodeCode" style="font-family: 'Courier New', monospace; font-size: 1.2em; font-weight: 700; margin-bottom: 10px;"></div>
                        <div id="barcodeName" style="font-size: 1em; margin-bottom: 15px;">Prodotto riconosciuto!</div>
                    </div>
                    <button class="btn" onclick="useBarcodeResult()" style="background: rgba(255,255,255,0.2); margin: 0; border: 2px solid rgba(255,255,255,0.3);">
                        ‚úÖ Usa Questo Prodotto
                    </button>
                </div>
                
                <div class="form-row">
                    <input type="text" id="productName" placeholder="Nome prodotto" class="form-input" />
                    <input type="number" id="productPrice" placeholder="Prezzo ‚Ç¨" step="0.01" class="form-input" />
                </div>
                <div class="form-row">
                    <select id="supermarketSelect" class="form-input">
                        <option value="">Seleziona supermercato</option>
                        <option value="Conad">Conad</option>
                        <option value="Coop">Coop</option>
                        <option value="Esselunga">Esselunga</option>
                        <option value="Carrefour">Carrefour</option>
                        <option value="Lidl">Lidl</option>
                        <option value="MD">MD</option>
                        <option value="Eurospin">Eurospin</option>
                        <option value="Penny">Penny Market</option>
                        <option value="Auchan">Auchan</option>
                        <option value="Ipercoop">Ipercoop</option>
                        <option value="Bennet">Bennet</option>
                        <option value="Altro">Altro</option>
                    </select>
                    <button class="btn" onclick="addProduct()" style="background: linear-gradient(45deg, #27ae60, #2ecc71); margin: 0;">
                        ‚ûï Aggiungi
                    </button>
                </div>
            </div>
            
            <!-- SEZIONE PRODOTTI -->
            <div class="section">
                <h2>üèÜ I Tuoi Prodotti</h2>
                <div style="margin-bottom: 20px;">
                    <input type="text" id="searchInput" placeholder="üîç Cerca prodotti..." class="form-input" style="margin-bottom: 0;" />
                </div>
                
                <div id="filterControls" style="margin-bottom: 20px;">
                    <div class="btn-grid" style="grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 8px;">
                        <button class="btn filter-btn active" onclick="filterProducts('all')" style="padding: 8px 12px; min-height: auto; font-size: 14px;" data-filter="all">
                            Tutti
                        </button>
                        <button class="btn filter-btn" onclick="filterProducts('ocr')" style="padding: 8px 12px; min-height: auto; font-size: 14px; background: linear-gradient(45deg, #3498db, #2980b9);" data-filter="ocr">
                            OCR
                        </button>
                        <button class="btn filter-btn" onclick="filterProducts('scanner')" style="padding: 8px 12px; min-height: auto; font-size: 14px; background: linear-gradient(45deg, #27ae60, #2ecc71);" data-filter="scanner">
                            Scanner
                        </button>
                        <button class="btn filter-btn" onclick="filterProducts('manual')" style="padding: 8px 12px; min-height: auto; font-size: 14px; background: linear-gradient(45deg, #9b59b6, #8e44ad);" data-filter="manual">
                            Manuali
                        </button>
                    </div>
                </div>
                
                <div id="productsContainer" class="products-grid">
                    <div style="text-align: center; padding: 40px; color: #666; grid-column: 1 / -1;">
                        <h3 style="margin-bottom: 10px;">Nessun prodotto ancora</h3>
                        <p>Inizia usando lo scanner barcode o l'OCR sui volantini!</p>
                    </div>
                </div>
            </div>
            
            <!-- SEZIONE CONTROLLI -->
            <div class="section">
                <h2>‚öôÔ∏è Gestione Dati</h2>
                <div class="btn-grid">
                    <button class="btn" style="background: linear-gradient(45deg, #3498db, #2980b9);" onclick="showStatistics()">
                        üìä Statistiche Dettagliate
                    </button>
                    <button class="btn" style="background: linear-gradient(45deg, #27ae60, #2ecc71);" onclick="exportData()">
                        üì§ Esporta Dati
                    </button>
                    <label class="btn" style="background: linear-gradient(45deg, #9b59b6, #8e44ad); cursor: pointer;">
                        üì• Importa Dati
                        <input type="file" accept=".json" onchange="importData(event)" style="display: none;">
                    </label>
                    <button class="btn" style="background: linear-gradient(45deg, #e74c3c, #c0392b);" onclick="clearAllData()">
                        üóëÔ∏è Cancella Tutto
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Variabili globali
        let products = [];
        let isScanning = false;
        let currentBarcode = null;
        let currentFlyerImage = null;
        let extractedOffers = [];
        let ocrWorker = null;
        let currentFilter = 'all';

        // Inizializzazione
        document.addEventListener('DOMContentLoaded', function() {
            loadData();
                    loadBarcodeCache();

                // Cache per prodotti barcode gi√† cercati
    let barcodeCache = {};
    
    function loadBarcodeCache() {
        try {
            const cached = localStorage.getItem('barcode_cache');
            if (cached) {
                barcodeCache = JSON.parse(cached);
            }
        } catch (error) {
            console.error('Errore caricamento cache:', error);
            barcodeCache = {};
        }
    }
    
    function saveBarcodeCache() {
        try {
            localStorage.setItem('barcode_cache', JSON.stringify(barcodeCache));
        } catch (error) {
            console.error('Errore salvataggio cache:', error);
        }
    }
            renderProducts();
            updateStats();
            setupEventListeners();
            showNotification('OfferteMax v4.1 caricato!', 'success');
        });

        function setupEventListeners() {
            document.getElementById('searchInput').addEventListener('input', renderProducts);
            
            // Gestione tasto Enter per aggiungere prodotto
            document.getElementById('productPrice').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    addProduct();
                }
            });
            
            // Auto-focus su prezzo dopo inserimento nome
            document.getElementById('productName').addEventListener('blur', function() {
                if (this.value.trim()) {
                    document.getElementById('productPrice').focus();
                }
            });
        }

        // ======= FUNZIONI OCR TESSERACT.JS REALE =======
        function showFlyerSources() {
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            modal.onclick = closeFlyerSources;
            
            modal.innerHTML = `
                <div class="modal-content" onclick="event.stopPropagation()">
                    <h2 style="color: #2c3e50; margin-bottom: 20px; text-align: center;">üåê Dove Trovare i Volantini</h2>
                    
                    <div class="info-box success-box">
                        <strong>‚úÖ Fonti Ufficiali Consigliate:</strong><br><br>
                        <strong>üè™ DoveConviene</strong><br>
                        Il pi√π completo database di volantini italiani<br>
                        <a href="https://www.doveconviene.it/iper-e-super" target="_blank" style="color: #3498db; text-decoration: none;">üîó www.doveconviene.it/iper-e-super</a><br><br>
                        
                        <strong>üì± PromoQui</strong><br>
                        Ottima alternativa con buona copertura<br>
                        <a href="https://www.promoqui.it/offerte/iper-supermercati" target="_blank" style="color: #3498db; text-decoration: none;">üîó www.promoqui.it/offerte/iper-supermercati</a><br><br>
                        
                        <strong>üìÑ VolantinoFacile</strong><br>
                        Interfaccia semplice e volantini sempre aggiornati<br>
                        <a href="https://www.volantinofacile.it/volantini-iper-supermercati" target="_blank" style="color: #3498db; text-decoration: none;">üîó www.volantinofacile.it</a>
                    </div>
                    
                    <div class="warning-box">
                        <strong>üí° Come usare l'OCR:</strong><br>
                        1. Scarica il volantino in alta qualit√†<br>
                        2. Assicurati che il testo sia leggibile<br>
                        3. Carica l'immagine e avvia l'OCR<br>
                        4. Verifica le offerte estratte prima di aggiungerle
                    </div>
                    
                    <div style="text-align: center; margin-top: 25px;">
                        <button class="btn" onclick="closeFlyerSources()" style="background: linear-gradient(45deg, #95a5a6, #7f8c8d); margin-right: 10px; display: inline-block; width: auto;">
                            Chiudi
                        </button>
                        <button class="btn" onclick="openDoveConviene()" style="background: linear-gradient(45deg, #27ae60, #2ecc71); display: inline-block; width: auto;">
                            Vai a DoveConviene
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function closeFlyerSources() {
            const modal = document.querySelector('.modal-overlay');
            if (modal) {
                document.body.removeChild(modal);
            }
        }

        function openDoveConviene() {
            window.open('https://www.doveconviene.it/iper-e-super', '_blank');
            closeFlyerSources();
            showNotification('Aperto DoveConviene - Scarica volantini e usa l\'OCR!', 'info');
        }

        function processOCRFlyer(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            if (file.size > 10 * 1024 * 1024) {
                showNotification('Immagine troppo grande (max 10MB)', 'warning');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                currentFlyerImage = e.target.result;
                document.getElementById('flyerImage').src = currentFlyerImage;
                document.getElementById('flyerPreview').style.display = 'block';
                showNotification('Immagine caricata! Pronto per l\'OCR', 'info');
            };
            reader.readAsDataURL(file);
            event.target.value = '';
        }

        async function startOCRAnalysis() {
            if (!currentFlyerImage) return;

            const analyzeBtn = document.getElementById('analyzeOCRBtn');
            const originalText = analyzeBtn.innerHTML;
            analyzeBtn.innerHTML = '<span class="loading-spinner"></span>Analisi OCR...';
            analyzeBtn.disabled = true;

            try {
                updateOCRProgress(5, 'Pre-elaborazione immagine...', 'Miglioramento contrasto');
                const processedImage = await preprocessImageForOCR(currentFlyerImage);
                document.getElementById('flyerImage').src = processedImage; // Mostra l'immagine processata

                updateOCRProgress(10, 'Inizializzazione Tesseract.js...', 'Caricamento worker...');

                const worker = await Tesseract.createWorker('ita', 1, {
                    logger: m => {
                        console.log(m);
                        if (m.status === 'recognizing text') {
                            updateOCRProgress(10 + Math.floor(m.progress * 80), 'Analisi in corso...', `Riconoscimento testo: ${Math.round(m.progress * 100)}%`);
                        } else {
                            updateOCRProgress(10, 'Inizializzazione Tesseract.js...', m.status);
                        }
                    },
                });

                // Parametri ottimizzati per volantini
                await worker.setParameters({
                    tessedit_pageseg_mode: Tesseract.PSM.SPARSE_TEXT_OSD,
                    preserve_interword_spaces: '1',
                });

                const { data } = await worker.recognize(processedImage);
                await worker.terminate();

                updateOCRProgress(90, 'Elaborazione testo estratto...', 'Ricerca offerte con logica contestuale');

                const ocrTextDisplay = document.getElementById('ocrTextDisplay');
                if (ocrTextDisplay) {
                    ocrTextDisplay.textContent = data.text;
                    ocrTextDisplay.style.display = 'block';
                }

                const offers = extractOffersFromText(data);

                updateOCRProgress(100, 'Analisi completata!', `Trovate ${offers.length} offerte potenziali`);

                if (offers.length > 0) {
                    displayExtractedOffers(offers);
                    showNotification(`OCR completato! Trovate ${offers.length} offerte (confidenza: ${Math.round(confidence)}%)`, 'success');
                } else {
                    showNotification(`OCR completato (confidenza: ${Math.round(confidence)}%) ma nessuna offerta rilevata - controlla il testo estratto`, 'warning');
                }

            } catch (error) {
                console.error('Errore OCR:', error);
                showNotification('Errore durante l\'analisi OCR: ' + (error.message || error), 'error');
            } finally {
                await worker.terminate();
                analyzeBtn.innerHTML = originalText;
                analyzeBtn.disabled = false;
                setTimeout(() => {
                    document.getElementById('ocrProgress').style.display = 'none';
                }, 2000);
            }
        }

        // Funzione per pre-processare l'immagine per l'OCR
        function preprocessImageForOCR(imageDataUrl) {
            return new Promise((resolve, reject) => {
                const img = new Image();
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');

                    // Aumenta la risoluzione per una migliore qualit√†
                    const scaleFactor = 2;
                    canvas.width = img.width * scaleFactor;
                    canvas.height = img.height * scaleFactor;

                    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                    const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                    const data = imageData.data;

                    // Converte in scala di grigi e aumenta il contrasto
                    for (let i = 0; i < data.length; i += 4) {
                        const avg = (data[i] + data[i + 1] + data[i + 2]) / 3;
                        let gray = avg;

                        // Applica una curva di contrasto
                        const contrast = 1.5;
                        gray = ( ( ( (gray/255) - 0.5) * contrast) + 0.5) * 255;

                        data[i] = data[i + 1] = data[i + 2] = Math.max(0, Math.min(255, gray));
                    }

                    ctx.putImageData(imageData, 0, 0);
                    resolve(canvas.toDataURL('image/jpeg', 0.9));
                };
                img.onerror = reject;
                img.src = imageDataUrl;
            });
        }

        // Funzione di pulizia testo (semplificata per la nuova logica)
        function cleanExtractedText(text) {
            return text.replace(/\b(offerta|sconto|prezzo|speciale|euro|‚Ç¨)\b/gi, '')
                       .replace(/[^a-zA-Z0-9\s√†√®√©√¨√≤√π%&'.,]/g, ' ') // Mantiene punti e virgole
                       .replace(/\s+/g, ' ').trim();
        }

        // NUOVA LOGICA OCR CONTESTUALE (v4.2)
        function extractOffersFromText(data) {
            const { words } = data;
            const offers = [];

            // Regex per identificare un prezzo, es. 1,99 o 0.85 o ‚Ç¨2.50
            const priceRegex = /^(?:‚Ç¨\s*)?(\d+[,.]\d{2})$/;

            // 1. Trova tutte le parole che sembrano un prezzo
            const priceWords = words.filter(w => priceRegex.test(w.text));

            // 2. Per ogni prezzo, cerca il prodotto associato
            for (const priceWord of priceWords) {
                const { bbox: priceBox, text: priceText, confidence } = priceWord;
                const price = parseFloat(priceText.replace(/‚Ç¨\s*/, '').replace(',', '.'));

                if (isNaN(price) || price <= 0.10 || price > 999) continue;

                // Criteri di ricerca spaziale
                const maxHorizontalDist = priceBox.x1 * 0.8; // Cerca a sinistra fino a 80% della larghezza
                const maxVerticalDist = (priceBox.y1 - priceBox.y0) * 3; // Cerca sopra fino a 3 volte l'altezza del prezzo

                const isSameLine = (box) => Math.abs((box.y0 + box.y1) / 2 - (priceBox.y0 + priceBox.y1) / 2) < (priceBox.y1 - priceBox.y0);
                const isAbove = (box) => priceBox.y0 - box.y1 > 0 && priceBox.y0 - box.y1 < maxVerticalDist;

                // 3. Cerca parole sulla stessa linea, a sinistra del prezzo
                let candidates = words.filter(w =>
                    w !== priceWord &&
                    isSameLine(w.bbox) &&
                    priceBox.x0 > w.bbox.x1 &&
                    priceBox.x0 - w.bbox.x1 < maxHorizontalDist
                );

                // 4. Se non trova nulla, cerca sulla linea immediatamente sopra
                if (candidates.length < 2) {
                    const wordsAbove = words.filter(w =>
                        w !== priceWord && isAbove(w.bbox)
                    );

                    // Prendi solo quelle allineate orizzontalmente con il prezzo
                    const priceCenterX = (priceBox.x0 + priceBox.x1) / 2;
                    const alignedWordsAbove = wordsAbove.filter(w =>
                         Math.abs((w.bbox.x0 + w.bbox.x1) / 2 - priceCenterX) < 150 // Tolleranza orizzontale
                    );

                    if (alignedWordsAbove.length > 0) {
                        candidates = alignedWordsAbove;
                    }
                }

                if (candidates.length === 0) continue;

                // 5. Unisci le parole candidate e pulisci il testo
                const productName = candidates.sort((a, b) => a.bbox.x0 - b.bbox.x0).map(w => w.text).join(' ');
                const cleanedName = cleanExtractedText(productName);

                if (cleanedName.length < 3) continue;

                offers.push({
                    name: capitalizeWords(cleanedName.substring(0, 80)),
                    price: price,
                    originalPrice: Math.round(price * (1.2 + Math.random() * 0.2) * 100) / 100,
                    supermarket: detectSupermarket(data.text),
                    confidence: confidence / 100,
                    extractedText: `${cleanedName} -> ${priceText}`,
                    fromOCR: true
                });
            }

            return removeSimilarOffers(offers);
        }
        
        function capitalizeWords(str) {
            return str.replace(/\b\w+/g, word => 
                word.charAt(0).toUpperCase() + word.slice(1).toLowerCase()
            ).replace(/\b(di|da|in|con|per|del|della|dei|delle|al|alla|ai|alle)\b/g, 
                     word => word.toLowerCase());
        }
        
        function detectSupermarket(text) {
            const supermarkets = {
                'conad': 'Conad',
                'coop': 'Coop', 
                'esselunga': 'Esselunga',
                'carrefour': 'Carrefour',
                'lidl': 'Lidl',
                'eurospin': 'Eurospin',
                'penny': 'Penny Market',
                'auchan': 'Auchan',
                'ipercoop': 'Ipercoop',
                'bennet': 'Bennet',
                'md': 'MD',
                'pam': 'PAM',
                'simply': 'Simply'
            };
            
            const lowerText = text.toLowerCase();
            for (const [key, name] of Object.entries(supermarkets)) {
                if (lowerText.includes(key)) {
                    return name;
                }
            }
            return 'Supermercato';
        }
        
        function removeSimilarOffers(offers) {
            const unique = [];
            const seen = new Set();
            
            offers.forEach(offer => {
                const key = `${offer.name.toLowerCase().substring(0, 15)}-${offer.price}`;
                if (!seen.has(key)) {
                    seen.add(key);
                    unique.push(offer);
                }
            });
            
            return unique.sort((a, b) => (b.originalPrice - b.price) - (a.originalPrice - a.price));
        }

        function updateOCRProgress(percentage, status, details = '') {
            document.getElementById('ocrProgress').style.display = 'block';
            document.getElementById('ocrProgressBar').style.width = percentage + '%';
            document.getElementById('ocrStatus').textContent = status;
            document.getElementById('ocrDetails').textContent = details;
        }

        function displayExtractedOffers(offers) {
            extractedOffers = offers;
            const container = document.getElementById('extractedOffers');
            container.innerHTML = '';
            
            offers.forEach((offer, index) => {
                const savings = offer.originalPrice - offer.price;
                const savingsPercent = Math.round((savings / offer.originalPrice) * 100);
                
                const offerCard = document.createElement('div');
                offerCard.className = 'product-card';
                offerCard.style.background = 'linear-gradient(145deg, #e8f5e8, #f0f8f0)';
                offerCard.style.animation = 'fadeIn 0.5s ease forwards';
                offerCard.style.animationDelay = (index * 0.1) + 's';
                
                offerCard.innerHTML = `
                    <div style="font-size: 1.2em; font-weight: 700; margin-bottom: 12px; color: #2c3e50;">${offer.name}</div>
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; flex-wrap: wrap; gap: 10px;">
                        <div>
                            <span style="text-decoration: line-through; color: #999; font-size: 0.9em;">‚Ç¨${offer.originalPrice.toFixed(2)}</span>
                            <span style="color: #27ae60; font-size: 1.6em; font-weight: 700; margin-left: 10px;">‚Ç¨${offer.price.toFixed(2)}</span>
                        </div>
                        <div style="background: rgba(39, 174, 96, 0.1); padding: 5px 12px; border-radius: 20px; font-size: 0.85em; font-weight: 600; color: #27ae60; border: 1px solid rgba(39, 174, 96, 0.3);">
                            ${offer.supermarket}
                        </div>
                    </div>
                    <div style="display: flex; gap: 10px; margin: 12px 0; flex-wrap: wrap;">
                        <div style="background: #27ae60; color: white; padding: 6px 12px; border-radius: 20px; font-size: 0.8em; font-weight: 600; text-align: center;">
                            Risparmi ‚Ç¨${savings.toFixed(2)} (-${savingsPercent}%)
                        </div>
                        <div style="background: #3498db; color: white; padding: 6px 12px; border-radius: 20px; font-size: 0.8em; font-weight: 600;">
                            OCR ${Math.round(offer.confidence * 100)}%
                        </div>
                    </div>
                    <div style="font-size: 0.75em; color: #666; margin: 8px 0; font-family: 'Courier New', monospace; background: #f8f9fa; padding: 8px; border-radius: 5px; border-left: 3px solid #3498db;">
                        "${offer.extractedText}"
                    </div>
                    <div style="text-align: center; margin-top: 15px;">
                        <button class="btn" onclick="addSingleExtractedOffer(${index})" style="background: linear-gradient(45deg, #27ae60, #2ecc71); padding: 10px 20px; font-size: 0.9em; margin: 0; min-height: auto;">
                            ‚úÖ Aggiungi Offerta
                        </button>
                    </div>
                `;
                
                container.appendChild(offerCard);
            });
            
            document.getElementById('flyerResults').style.display = 'block';
        }

        function addSingleExtractedOffer(index) {
            const offer = extractedOffers[index];
            if (!offer) return;
            
            products.push({
                id: Date.now() + Math.random(),
                name: offer.name,
                price: offer.price,
                supermarket: offer.supermarket,
                date: new Date(),
                fromOCR: true,
                originalPrice: offer.originalPrice,
                confidence: offer.confidence
            });
            
            // Rimuovi l'offerta dalla lista e aggiorna display
            extractedOffers.splice(index, 1);
            displayExtractedOffers(extractedOffers);
            renderProducts();
            updateStats();
            saveData();
            
            showNotification(`"${offer.name}" aggiunto alla tua lista!`, 'success');
            
            if (extractedOffers.length === 0) {
                document.getElementById('flyerResults').style.display = 'none';
                showNotification('Tutte le offerte OCR sono state aggiunte!', 'info');
            }
        }

        function addAllExtractedOffers() {
            if (extractedOffers.length === 0) return;
            
            const count = extractedOffers.length;
            
            extractedOffers.forEach((offer, index) => {
                products.push({
                    id: Date.now() + index + Math.random(),
                    name: offer.name,
                    price: offer.price,
                    supermarket: offer.supermarket,
                    date: new Date(),
                    fromOCR: true,
                    originalPrice: offer.originalPrice,
                    confidence: offer.confidence
                });
            });
            
            extractedOffers = [];
            document.getElementById('flyerResults').style.display = 'none';
            renderProducts();
            updateStats();
            saveData();
            
            showNotification(`${count} offerte OCR aggiunte alla tua lista!`, 'success');
        }

        function clearFlyerPreview() {
            document.getElementById('flyerPreview').style.display = 'none';
            document.getElementById('flyerResults').style.display = 'none';
            document.getElementById('ocrProgress').style.display = 'none';
            document.getElementById('ocrTextDisplay').style.display = 'none';
            currentFlyerImage = null;
            extractedOffers = [];
        }

        // ======= SCANNER BARCODE REALE (v4.2 con BarcodeDetector API) =======
        let videoStream = null;
        const isNativeScannerSupported = 'BarcodeDetector' in window && navigator.mediaDevices && navigator.mediaDevices.getUserMedia;

        function toggleScanner() {
            if (isScanning) {
                stopScanner();
            } else {
                if (isNativeScannerSupported) {
                    startNativeScanner();
                } else {
                    startQuaggaScanner(); // Fallback
                    showNotification('Scanner di fallback in uso (browser non supportato)', 'warning');
                }
            }
        }

        async function startNativeScanner() {
            const container = document.getElementById('scannerContainer');
            const previewContainer = document.getElementById('scanner-preview');
            previewContainer.innerHTML = '<video id="native-scanner-video" style="width: 100%; height: 100%; object-fit: cover;" autoplay playsinline></video>';
            const videoEl = document.getElementById('native-scanner-video');

            container.classList.add('active');
            isScanning = true;

            try {
                videoStream = await navigator.mediaDevices.getUserMedia({
                    video: {
                        facingMode: 'environment',
                        width: { ideal: 1920 },
                        height: { ideal: 1080 }
                    }
                });
                videoEl.srcObject = videoStream;
                showNotification('Scanner nativo attivo! (Pi√π veloce e preciso)', 'success');

                const barcodeDetector = new BarcodeDetector({ formats: ['ean_13', 'ean_8', 'code_128', 'upc_a'] });

                const detectFrame = async () => {
                    if (!isScanning) return;
                    try {
                        const barcodes = await barcodeDetector.detect(videoEl);
                        if (barcodes.length > 0) {
                            onBarcodeDetected({ codeResult: { code: barcodes[0].rawValue } });
                        } else {
                            requestAnimationFrame(detectFrame);
                        }
                    } catch (e) {
                        console.error('Errore durante la scansione nativa:', e);
                        if (isScanning) requestAnimationFrame(detectFrame);
                    }
                };

                videoEl.onloadedmetadata = () => {
                    detectFrame();
                };

            } catch (err) {
                console.error('Errore accesso camera (nativo):', err);
                showNotification(`Errore camera: ${err.message}`, 'error');
                stopScanner();
                // Se fallisce, prova il fallback
                showNotification('Scanner nativo fallito, avvio fallback...', 'warning');
                startQuaggaScanner();
            }
        }

        // Scanner di fallback Quagga.js
        function startQuaggaScanner() {
            const container = document.getElementById('scannerContainer');
            container.classList.add('active');
            isScanning = true;

            const constraints = {
                video: {
                    facingMode: "environment",
                    width: { ideal: 1280 }, // Risoluzione leggermente ridotta per Quagga
                    height: { ideal: 720 }
                }
            };

            navigator.mediaDevices.getUserMedia(constraints)
                .then(stream => {
                    videoStream = stream; // Store the stream to stop it later
                    Quagga.init({
                        inputStream: {
                            name: "Live",
                            type: "LiveStream",
                            target: document.querySelector('#scanner-preview'),
                            constraints: constraints.video,
                            area: { top: "20%", right: "10%", left: "10%", bottom: "20%" }
                        },
                        locator: { patchSize: "large", halfSample: true },
                        numOfWorkers: 2,
                        frequency: 10,
                        decoder: { readers: ["ean_reader", "ean_8_reader"] },
                        locate: true
                    }, function(err) {
                        if (err) {
                            console.error('Errore Quagga:', err);
                            showNotification('Errore scanner fallback: ' + err.message, 'error');
                            stopScanner();
                            return;
                        }
                        Quagga.start();
                    });
                    Quagga.onDetected(onBarcodeDetected);
                })
                .catch(err => {
                    console.error('Errore accesso camera (Quagga):', err);
                    showNotification('Impossibile accedere alla camera: ' + err.message, 'error');
                    stopScanner();
                });
        }

        function stopScanner() {
            const container = document.getElementById('scannerContainer');
            container.classList.remove('active');
            isScanning = false;
            
            // Ferma lo stream video (per entrambi gli scanner)
            if (videoStream) {
                videoStream.getTracks().forEach(track => track.stop());
                videoStream = null;
            }

            // Ferma Quagga se era in uso
            if (typeof Quagga !== 'undefined') {
                try {
                    Quagga.stop();
                    Quagga.offDetected(onBarcodeDetected);
                } catch(e) { /* Potrebbe non essere inizializzato */ }
            }
            
            showNotification('Scanner fermato', 'info');
        }

        async function onBarcodeDetected(result) {
            const code = result.codeResult.code;
            
            // Validazione barcode
            if (!code || code.length < 8 || !/^\d+$/.test(code)) {
                return;
            }
            
            // Evita scansioni duplicate consecutive
            if (currentBarcode === code) {
                return;
            }
            
            currentBarcode = code;
            stopScanner();
            
            showNotification('Codice rilevato! Ricerca prodotto...', 'info');
            
            // Vibrazione per feedback
            if (navigator.vibrate) {
                navigator.vibrate([100, 50, 100]);
            }
            
            // Ricerca prodotto tramite API OpenFoodFacts
            const productInfo = await getProductFromBarcode(code);
            
            document.getElementById('barcodeCode').textContent = code;
            document.getElementById('barcodeName').textContent = productInfo.name;
            document.getElementById('barcodeResult').style.display = 'block';
            
            // Auto-compila il form dopo un secondo
            setTimeout(() => {
                document.getElementById('productName').value = productInfo.name;
                document.getElementById('productPrice').focus();
            }, 1000);
        }

        async function getProductFromBarcode(barcode) {
            try {
                showNotification('Ricerca su database OpenFoodFacts...', 'info');

                        // Controlla cache prima di chiamare API
        if (barcodeCache[barcode]) {
            showNotification(`Trovato in cache: ${barcodeCache[barcode]}`, 'success');
            return { name: barcodeCache[barcode], source: 'Cache Locale' };
        }
                
                // Timeout per evitare attese infinite
                const timeoutPromise = new Promise((_, reject) => 
                    setTimeout(() => reject(new Error('Timeout ricerca')), 8000)
                );
                
                // Prima prova: API italiana con CORS proxy
                try {
                    const corsProxy = 'https://corsproxy.io/?';
                    const italianUrl = `${corsProxy}https://it.openfoodfacts.org/api/v0/product/${barcode}.json`;
                    
                    const italianResponse = await Promise.race([
                        fetch(italianUrl),
                        timeoutPromise
                    ]);
                    
                    if (italianResponse.ok) {
                        const italianData = await italianResponse.json();
                        
                        if (italianData.status === 1 && italianData.product) {
                            const productName = extractProductName(italianData.product);
                            
                            if (productName) {
                                showNotification(`Trovato: ${productName}`, 'success');
                                // Salva in cache
                                barcodeCache[barcode] = productName;
                                saveBarcodeCache();
                                                                return { name: productName, source: 'OpenFoodFacts IT' };
                            }
                        }
                    }
                } catch (italianError) {
                    console.log('API italiana non disponibile:', italianError.message);
                }
                
                // Seconda prova: API mondiale con proxy alternativo
                try {
                    const altProxy = 'https://api.allorigins.win/raw?url=';
                    const globalUrl = `${altProxy}https://world.openfoodfacts.org/api/v0/product/${barcode}.json`;
                    
                    const globalResponse = await Promise.race([
                        fetch(globalUrl),
                        timeoutPromise
                    ]);
                    
                    if (globalResponse.ok) {
                        const globalData = await globalResponse.json();
                        
                        if (globalData.status === 1 && globalData.product) {
                            const productName = extractProductName(globalData.product);
                            
                            if (productName) {
                                showNotification(`Trovato nel database mondiale: ${productName}`, 'success');
                                // Salva in cache
                                barcodeCache[barcode] = productName;
                                saveBarcodeCache();
                                                                return { name: productName, source: 'OpenFoodFacts Global' };
                            }
                        }
                    }
                } catch (globalError) {
                    console.log('API mondiale non disponibile:', globalError.message);
                }
                
                // Fallback: database locale prodotti comuni
                const localProduct = getLocalProduct(barcode);
                if (localProduct) {
                    showNotification(`Trovato in cache locale: ${localProduct}`, 'info');
                    return { name: localProduct, source: 'Cache Locale' };
                }
                
                // Ultimo fallback: codice generico
                showNotification('Prodotto non trovato nei database - inserisci manualmente', 'warning');
                return { name: `Prodotto ${barcode}`, source: 'Non trovato' };
                
            } catch (error) {
                console.error('Errore ricerca prodotto:', error);
                showNotification('Errore di rete - usa database locale', 'warning');
                
                const localProduct = getLocalProduct(barcode);
                if (localProduct) {
                    return { name: localProduct, source: 'Cache Locale (offline)' };
                }
                
                return { name: `Prodotto ${barcode}`, source: 'Errore rete' };
            }
        }

        function extractProductName(product) {
            let nameParts = [];

            // 1. Brand
            let brand = '';
            if (product.brands) {
                brand = product.brands.split(',')[0].trim();
                if (brand) {
                    nameParts.push(brand);
                }
            }

            // 2. Product Name
            let productName = product.product_name_it ||
                              product.product_name_en ||
                              product.product_name ||
                              product.generic_name_it ||
                              product.generic_name_en ||
                              product.generic_name || '';
            
            if (productName) {
                // Clean product name and remove brand if it's already there to avoid duplication
                let cleanedProductName = productName.trim();
                if (brand && cleanedProductName.toLowerCase().startsWith(brand.toLowerCase())) {
                    cleanedProductName = cleanedProductName.substring(brand.length).trim();
                }
                if (cleanedProductName) {
                    nameParts.push(cleanedProductName);
                }
            }

            // 3. Quantity
            let quantity = product.quantity || '';
            if (quantity) {
                // Avoid adding quantity if it's already in the product name
                const nameSoFar = nameParts.join(' ').toLowerCase();
                const quantityStr = String(quantity).toLowerCase();
                if (!nameSoFar.includes(quantityStr)) {
                    nameParts.push(quantity);
                }
            }
            
            // Join parts and clean up
            let finalName = nameParts.join(' ');
            return finalName.replace(/\s+/g, ' ').trim();
        }

 function getLocalProduct(barcode) {
     const localProducts = {
       // Pasta e riso
       '8076800195057': 'Barilla Spaghetti N.5 500g',
       '8076809513470': 'Barilla Penne Rigate N.73 500g',
       '8076809513525': 'Barilla Fusilli N.98 500g',
       '8076800377057': 'Barilla Integrale Penne N.73 500g',
       '8001510001640': 'De Cecco Spaghetti N.12 500g',
       '8001510004900': 'De Cecco Penne Rigate N.41 500g',
       '8076809523745': 'Barilla Risotto Arborio 1kg',
       '8003380070372': 'Scotti Riso Arborio 1kg',
       
       // Sughi e condimenti
       '8000139006041': 'Nutella 450g',
       '8001505005707': 'Bertolli Olio Extra Vergine 1L',
       '8001505077418': 'Mutti Passata di Pomodoro 700g',
       '8001505005011': 'Bertolli Classico Sugo 400g',
       '8000130770207': 'Parmigiano Reggiano DOP 200g',
       '8003170063617': 'Galbani Parmigiano Reggiano 200g',
       '8003170087323': 'Galbani Grana Padano DOP 250g',
       '8002210003057': 'Ponti Aceto Balsamico Modena 500ml',
       '8001100067234': 'Mielizia Miele Millefiori 250g',
       '8017277005006': 'Divella Olio Extra Vergine 1L',
       
       // Latte e derivati
       '8000560010855': 'Parmalat Latte UHT Intero 1L',
       '8001120000088': 'Granarolo Latte Fresco Intero 1L',
       '8000560752059': 'Parmalat Zymil Latte 1L',
       '8000500037850': 'Galbani Santa Lucia Mozzarella 125g',
       '8024370011178': 'Vallelata Burger Mozzarella 3x100g',
       '8002620003400': 'Giglio Ricotta Fresca 250g',
       
       // Bevande
       '8000070046351': 'Coca Cola Lattina 330ml',
       '8000070025790': 'Fanta Arancia Lattina 330ml',
       '8000070012202': 'Sprite Lattina 330ml',
       '8000400002212': 'San Pellegrino Acqua Naturale 1L',
       '8000400002007': 'San Pellegrino Acqua Frizzante 1L',
       '5449000000996': 'Coca Cola Bottiglia 1.5L',
       '8001620010518': 'Ferrarelle Acqua Frizzante 1.5L',
       '8003170063402': 'Levissima Acqua Naturale 1.5L',
       '8001620004309': 'Fonte Essenziale Acqua 1.5L',
       '8000120001000': 'San Benedetto Acqua Naturale 1.5L',
       
       // Snack e dolci
       '8000139018800': 'Kinder Bueno T2 43g',
       '8000139035609': 'Ferrero Rocher T16 200g',
       '8000139001186': 'Tic Tac Mint 18g',
       '8000300307856': 'Mulino Bianco Macine 350g',
       '8000300300734': 'Mulino Bianco Baiocchi 260g',
       '8000300306415': 'Mulino Bianco Abbracci 350g',
       '8000300311839': 'Mulino Bianco Pan di Stelle 350g',
       '7622210449238': 'Oreo Biscotti 176g',
       '8000700310182': 'Pavesini Biscotti 200g',
       '8000300318074': 'Gran Cereale Biscotti 500g',
       
       // Prodotti per la casa
       '8712566456871': 'Dash Detersivo Liquido 20 Lavaggi',
       '8710398710321': 'Nivea Crema Idratante Corpo 400ml',
       '8000070021457': 'Scottex Carta Igienica 12 Rotoli',
       '8001030017693': 'Swiffer Panni Catturapolvere x24',
       '8001841384672': 'Mastro Lindo Universale 1L',
       '5413149647459': 'Finish Quantum Max 50 Tabs',
       '8001090077080': 'Dixan Detersivo Polvere 50 Lavaggi',
       '8001841024080': 'ACE Gentile Candeggina 2L',
       '8001090085795': 'Perlana Sport 1.5L',
       '8001480801554': 'Cif Crema Limone 750ml',
       
       // Conserve e scatolame
       '8001440102110': 'Rio Mare Tonno Olio Oliva 80g x3',
       '8004030026544': 'Cirio Pelati 400g',
       '8001510000315': 'De Rica Polpa Pomodoro 400g',
       '8002780010007': 'Valfrutta Piselli 410g',
       '8003170063891': 'Simmenthal 90g',
       '8076800377927': 'Wasa Crackers Integrali 275g',
       
       // Surgelati comuni (per referenza)
       '8001120000347': 'Findus Bastoncini 300g',
       '8001120001184': 'Findus Minestrone 1kg',
       '8024370023331': 'Four Salti Pizza Margherita'
     };
     
     return localProducts[barcode];
   }


        function useBarcodeResult() {
            if (currentBarcode) {
                const barcodeName = document.getElementById('barcodeName').textContent;
                document.getElementById('productName').value = barcodeName;
                document.getElementById('barcodeResult').style.display = 'none';
                document.getElementById('productPrice').focus();
                showNotification('Nome prodotto copiato nel form!', 'success');
            }
        }

        // ======= GESTIONE PRODOTTI =======
        function addProduct() {
            const name = document.getElementById('productName').value.trim();
            const price = parseFloat(document.getElementById('productPrice').value);
            const supermarket = document.getElementById('supermarketSelect').value;
            
            if (!name || !price || !supermarket) {
                showNotification('Compila tutti i campi per aggiungere il prodotto!', 'warning');
                return;
            }
            
            if (price <= 0) {
                showNotification('Il prezzo deve essere maggiore di zero!', 'warning');
                return;
            }
            
            if (price > 1000) {
                showNotification('Prezzo troppo alto, controlla se √® corretto', 'warning');
                return;
            }
            
            const newProduct = {
                id: Date.now() + Math.random(),
                name: name,
                price: price,
                supermarket: supermarket,
                date: new Date(),
                fromScanner: !!currentBarcode,
                barcode: currentBarcode || null
            };
            
            products.push(newProduct);
            
            // Reset form
            document.getElementById('productName').value = '';
            document.getElementById('productPrice').value = '';
            document.getElementById('supermarketSelect').value = '';
            document.getElementById('barcodeResult').style.display = 'none';
            currentBarcode = null;
            
            renderProducts();
            updateStats();
            saveData();
            showNotification(`"${name}" aggiunto con successo!`, 'success');
        }

        function filterProducts(filterType) {
            currentFilter = filterType;
            
            // Aggiorna pulsanti filtro
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.filter === filterType) {
                    btn.classList.add('active');
                }
            });
            
            renderProducts();
        }

        function renderProducts() {
            const container = document.getElementById('productsContainer');
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            
            let filteredProducts = products.filter(product => {
                const matchesSearch = product.name.toLowerCase().includes(searchTerm) || 
                                    product.supermarket.toLowerCase().includes(searchTerm);
                
                if (!matchesSearch) return false;
                
                switch (currentFilter) {
                    case 'ocr':
                        return product.fromOCR;
                    case 'scanner':
                        return product.fromScanner;
                    case 'manual':
                        return !product.fromOCR && !product.fromScanner;
                    default:
                        return true;
                }
            });
            
            if (filteredProducts.length === 0) {
                const emptyMessage = currentFilter === 'all' 
                    ? 'Nessun prodotto trovato. Inizia usando lo scanner barcode o l\'OCR sui volantini!'
                    : `Nessun prodotto trovato per il filtro "${currentFilter.toUpperCase()}".`;
                    
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #666; grid-column: 1 / -1;">
                        <h3 style="margin-bottom: 10px;">${emptyMessage}</h3>
                        ${currentFilter !== 'all' ? '<p>Prova a cambiare filtro o cerca qualcos\'altro.</p>' : ''}
                    </div>
                `;
                return;
            }
            
            // Raggruppa prodotti simili per confronto prezzi
            const groupedProducts = groupSimilarProducts(filteredProducts);
            
            container.innerHTML = '';
            
            groupedProducts.forEach((group, groupIndex) => {
                const productCard = createProductCard(group);
                productCard.style.animationDelay = (groupIndex * 0.1) + 's';
                container.appendChild(productCard);
            });
        }

        function groupSimilarProducts(products) {
            const groups = [];
            
            products.forEach(product => {
                let foundGroup = false;
                
                for (let group of groups) {
                    if (isSimilarProduct(product.name, group[0].name)) {
                        group.push(product);
                        foundGroup = true;
                        break;
                    }
                }
                
                if (!foundGroup) {
                    groups.push([product]);
                }
            });
            
            return groups;
        }

        function isSimilarProduct(name1, name2) {
            const words1 = name1.toLowerCase().split(' ').filter(w => w.length > 2);
            const words2 = name2.toLowerCase().split(' ').filter(w => w.length > 2);
            
            if (words1.length === 0 || words2.length === 0) return false;
            
            let commonWords = 0;
            words1.forEach(word => {
                if (words2.some(w => w.includes(word) || word.includes(w))) {
                    commonWords++;
                }
            });
            
            return commonWords >= Math.min(words1.length, words2.length) * 0.6;
        }

        function createProductCard(productGroup) {
            const card = document.createElement('div');
            card.className = 'product-card';
            card.style.animation = 'fadeIn 0.5s ease forwards';
            
            if (productGroup.length === 1) {
                const product = productGroup[0];
                const dateStr = new Date(product.date).toLocaleDateString('it-IT');
                
                card.innerHTML = `
                    <div style="font-size: 1.3em; font-weight: 700; margin-bottom: 10px; color: #2c3e50;">${product.name}</div>
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; flex-wrap: wrap; gap: 10px;">
                        <span style="color: #27ae60; font-size: 1.5em; font-weight: 700;">‚Ç¨${product.price.toFixed(2)}</span>
                        <span style="background: rgba(102, 126, 234, 0.1); padding: 5px 10px; border-radius: 20px; font-size: 0.9em; font-weight: 600; color: #667eea;">${product.supermarket}</span>
                    </div>
                    <div style="display: flex; gap: 8px; margin: 10px 0; flex-wrap: wrap;">
                        ${product.fromOCR ? '<span style="background: #3498db; color: white; padding: 4px 8px; border-radius: 12px; font-size: 0.7em; font-weight: 600;">OCR</span>' : ''}
                        ${product.fromScanner ? '<span style="background: #27ae60; color: white; padding: 4px 8px; border-radius: 12px; font-size: 0.7em; font-weight: 600;">SCANNER</span>' : ''}
                        <span style="background: #95a5a6; color: white; padding: 4px 8px; border-radius: 12px; font-size: 0.7em; font-weight: 600;">${dateStr}</span>
                    </div>
                    <div style="text-align: center; margin-top: 15px;">
                        <button class="btn" onclick="deleteProduct(${product.id})" style="background: linear-gradient(45deg, #e74c3c, #c0392b); padding: 12px 20px; font-size: 0.9em; margin: 0; min-height: auto;">
                            Elimina
                        </button>
                    </div>
                `;
            } else {
                // Prodotti simili - mostra confronto prezzi
                const sortedByPrice = [...productGroup].sort((a, b) => a.price - b.price);
                const bestPrice = sortedByPrice[0];
                const worstPrice = sortedByPrice[sortedByPrice.length - 1];
                const avgPrice = productGroup.reduce((sum, p) => sum + p.price, 0) / productGroup.length;
                const savings = worstPrice.price - bestPrice.price;
                const maxSavings = avgPrice - bestPrice.price;
                
                card.style.background = savings > 1 ? 'linear-gradient(135deg, #a8e6cf, #dcedc1)' : card.style.background;
                
                card.innerHTML = `
                    <div style="font-size: 1.3em; font-weight: 700; margin-bottom: 12px; color: #2c3e50;">${bestPrice.name}</div>
                    <div style="margin-bottom: 15px;">
                        <div style="color: #666; font-size: 0.9em; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center;">
                            <span>${productGroup.length} offerte trovate</span>
                            <span style="font-weight: 600; color: #27ae60;">Risparmio max: ‚Ç¨${maxSavings.toFixed(2)}</span>
                        </div>
                        <div style="max-height: 150px; overflow-y: auto; padding-right: 5px;">
                            ${sortedByPrice.map(p => `
                                <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px; margin: 4px 0; border-radius: 8px; ${p === bestPrice ? 'background: rgba(39, 174, 96, 0.1); border: 1px solid rgba(39, 174, 96, 0.3);' : 'background: rgba(0,0,0,0.02);'}">
                                    <div>
                                        <span style="${p === bestPrice ? 'font-weight: bold; color: #27ae60; font-size: 1.1em;' : ''}">‚Ç¨${p.price.toFixed(2)}</span>
                                        <span style="font-size: 0.8em; color: #666; margin-left: 8px;">${p.supermarket}</span>
                                        ${p.fromOCR ? '<span style="background: #3498db; color: white; padding: 2px 6px; border-radius: 8px; font-size: 0.6em; margin-left: 5px;">OCR</span>' : ''}
                                        ${p.fromScanner ? '<span style="background: #27ae60; color: white; padding: 2px 6px; border-radius: 8px; font-size: 0.6em; margin-left: 5px;">SCAN</span>' : ''}
                                    </div>
                                    ${p === bestPrice ? '<span style="background: #27ae60; color: white; padding: 4px 8px; border-radius: 12px; font-size: 0.7em; font-weight: 600;">MIGLIORE</span>' : ''}
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    ${savings > 0.5 ? `
                    <div style="background: linear-gradient(45deg, #27ae60, #2ecc71); color: white; padding: 12px; border-radius: 12px; text-align: center; margin-bottom: 15px; box-shadow: 0 4px 15px rgba(39, 174, 96, 0.3);">
                        <strong>Risparmia ‚Ç¨${savings.toFixed(2)}</strong><br>
                        <span style="font-size: 0.9em; opacity: 0.9;">scegliendo ${bestPrice.supermarket} invece di ${worstPrice.supermarket}</span>
                    </div>` : ''}
                    <div style="display: flex; gap: 10px; justify-content: center;">
                        <button class="btn" onclick="deleteProductGroup('${bestPrice.name.replace(/'/g, "\\\'")}')" style="background: linear-gradient(45deg, #e74c3c, #c0392b); padding: 12px 20px; font-size: 0.9em; margin: 0; min-height: auto; flex: 1; max-width: 200px;">
                            Elimina Gruppo
                        </button>
                    </div>
                `;
            }
            
            return card;
        }

        function deleteProduct(productId) {
            if (confirm('Eliminare questo prodotto dalla lista?')) {
                products = products.filter(p => p.id !== productId);
                renderProducts();
                updateStats();
                saveData();
                showNotification('Prodotto eliminato', 'info');
            }
        }

        function deleteProductGroup(productName) {
            const similarProducts = products.filter(p => isSimilarProduct(p.name, productName));
            
            if (confirm(`Eliminare tutte le ${similarProducts.length} offerte per "${productName}"?`)) {
                const initialCount = products.length;
                products = products.filter(p => !isSimilarProduct(p.name, productName));
                const deletedCount = initialCount - products.length;
                
                renderProducts();
                updateStats();
                saveData();
                showNotification(`${deletedCount} offerte eliminate`, 'info');
            }
        }

        // ======= STATISTICHE =======
        function updateStats() {
            const totalProducts = products.length;
            document.getElementById('totalProducts').textContent = totalProducts;
            
            if (totalProducts === 0) {
                document.getElementById('totalSavings').textContent = '‚Ç¨0';
                document.getElementById('bestDeal').textContent = '-';
                document.getElementById('avgPrice').textContent = '‚Ç¨0';
                return;
            }
            
            // Calcola risparmi stimati (basato su prezzi OCR con originalPrice)
            let totalSavings = 0;
            let bestDealText = '-';
            let maxSaving = 0;
            
            products.forEach(product => {
                if (product.originalPrice && product.originalPrice > product.price) {
                    const saving = product.originalPrice - product.price;
                    totalSavings += saving;
                    
                    if (saving > maxSaving) {
                        maxSaving = saving;
                        bestDealText = `‚Ç¨${saving.toFixed(2)} su ${product.name.substring(0, 20)}...`;
                    }
                }
            });
            
            // Prezzo medio
            const avgPrice = products.reduce((sum, p) => sum + p.price, 0) / totalProducts;
            
            document.getElementById('totalSavings').textContent = `‚Ç¨${totalSavings.toFixed(2)}`;
            document.getElementById('bestDeal').textContent = bestDealText;
            document.getElementById('avgPrice').textContent = `‚Ç¨${avgPrice.toFixed(2)}`;
        }

        function showStatistics() {
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            modal.onclick = closeStatistics;
            
            const ocrCount = products.filter(p => p.fromOCR).length;
            const scannerCount = products.filter(p => p.fromScanner).length;
            const manualCount = products.length - ocrCount - scannerCount;
            
            const supermarketStats = {};
            products.forEach(p => {
                supermarketStats[p.supermarket] = (supermarketStats[p.supermarket] || 0) + 1;
            });
            
            const topSupermarkets = Object.entries(supermarketStats)
                .sort(([,a], [,b]) => b - a)
                .slice(0, 5);
            
            const recentProducts = [...products]
                .sort((a, b) => new Date(b.date) - new Date(a.date))
                .slice(0, 5);
            
            modal.innerHTML = `
                <div class="modal-content" onclick="event.stopPropagation()">
                    <h2 style="color: #2c3e50; margin-bottom: 25px; text-align: center;">Statistiche Dettagliate</h2>
                    
                    <div class="stats-container">
                        <div class="stat-card">
                            <div class="stat-number">${products.length}</div>
                            <div class="stat-label">Prodotti Totali</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" style="color: #3498db;">${ocrCount}</div>
                            <div class="stat-label">Da OCR</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" style="color: #27ae60;">${scannerCount}</div>
                            <div class="stat-label">Da Scanner</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" style="color: #9b59b6;">${manualCount}</div>
                            <div class="stat-label">Manuali</div>
                        </div>
                    </div>
                    
                    <h3 style="color: #2c3e50; margin: 25px 0 15px 0;">Top Supermercati</h3>
                    <div>
                        ${topSupermarkets.map(([name, count]) => `
                            <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px; margin: 5px 0; background: #f8f9fa; border-radius: 8px;">
                                <span style="font-weight: 600;">${name}</span>
                                <span style="color: #27ae60; font-weight: 700;">${count} prodotti</span>
                            </div>
                        `).join('')}
                    </div>
                    
                    <h3 style="color: #2c3e50; margin: 25px 0 15px 0;">Aggiunti di Recente</h3>
                    <div style="max-height: 200px; overflow-y: auto;">
                        ${recentProducts.map(p => `
                            <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px; margin: 3px 0; background: #f8f9fa; border-radius: 8px; font-size: 0.9em;">
                                <span>${p.name.substring(0, 30)}${p.name.length > 30 ? '...' : ''}</span>
                                <span style="color: #27ae60; font-weight: 600;">‚Ç¨${p.price.toFixed(2)}</span>
                            </div>
                        `).join('')}
                    </div>
                    
                    <div style="text-align: center; margin-top: 25px;">
                        <button class="btn" onclick="closeStatistics()" style="background: linear-gradient(45deg, #95a5a6, #7f8c8d); display: inline-block; width: auto; margin: 0;">
                            Chiudi
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function closeStatistics() {
            const modal = document.querySelector('.modal-overlay');
            if (modal) {
                document.body.removeChild(modal);
            }
        }

        // ======= GESTIONE DATI =======
        function saveData() {
            try {
                const dataToSave = {
                    products: products,
                    version: '4.1',
                    lastSaved: new Date().toISOString(),
                    stats: {
                        totalProducts: products.length,
                        ocrProducts: products.filter(p => p.fromOCR).length,
                        scannerProducts: products.filter(p => p.fromScanner).length
                    }
                };
                localStorage.setItem('offertemax_data', JSON.stringify(dataToSave));
            } catch (error) {
                console.error('Errore salvataggio:', error);
                showNotification('Errore nel salvataggio dei dati', 'error');
            }
        }

        function loadData() {
            try {
                const savedData = localStorage.getItem('offertemax_data');
                if (savedData) {
                    const parsed = JSON.parse(savedData);
                    products = parsed.products || [];
                    
                    // Migrazione dati da versioni precedenti
                    products.forEach(product => {
                        if (!product.id) {
                            product.id = Date.now() + Math.random();
                        }
                        if (!product.date) {
                            product.date = new Date();
                        }
                    });
                    
                    if (products.length > 0) {
                        showNotification(`Caricati ${products.length} prodotti salvati`, 'success');
                    }
                }
            } catch (error) {
                console.error('Errore caricamento:', error);
                products = [];
                showNotification('Errore nel caricamento dei dati salvati', 'error');
            }
        }

        function clearAllData() {
            if (confirm('ATTENZIONE: Questa operazione eliminer√† tutti i tuoi prodotti salvati.\n\nSei sicuro di voler continuare?')) {
                products = [];
                extractedOffers = [];
                currentFlyerImage = null;
                currentBarcode = null;
                
                localStorage.removeItem('offertemax_data');
                
                renderProducts();
                updateStats();
                
                document.getElementById('flyerResults').style.display = 'none';
                document.getElementById('flyerPreview').style.display = 'none';
                document.getElementById('barcodeResult').style.display = 'none';
                
                showNotification('Tutti i dati sono stati eliminati', 'info');
            }
        }

        function exportData() {
            try {
                const dataToExport = {
                    products: products,
                    exportDate: new Date().toISOString(),
                    version: '4.1',
                    metadata: {
                        totalProducts: products.length,
                        ocrProducts: products.filter(p => p.fromOCR).length,
                        scannerProducts: products.filter(p => p.fromScanner).length,
                        manualProducts: products.filter(p => !p.fromOCR && !p.fromScanner).length
                    }
                };
                
                const blob = new Blob([JSON.stringify(dataToExport, null, 2)], {
                    type: 'application/json'
                });
                
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `offertemax_backup_${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                showNotification(`Dati esportati! (${products.length} prodotti)`, 'success');
            } catch (error) {
                console.error('Errore esportazione:', error);
                showNotification('Errore durante l\'esportazione', 'error');
            }
        }

        function importData(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const importedData = JSON.parse(e.target.result);
                    
                    if (importedData.products && Array.isArray(importedData.products)) {
                        const importCount = importedData.products.length;
                        
                        if (confirm(`Importare ${importCount} prodotti?\n\nATTENZIONE: I dati attuali saranno sostituiti.`)) {
                            products = importedData.products.map(p => ({
                                ...p,
                                id: p.id || (Date.now() + Math.random()),
                                date: p.date || new Date()
                            }));
                            
                            renderProducts();
                            updateStats();
                            saveData();
                            showNotification(`${importCount} prodotti importati con successo!`, 'success');
                        }
                    } else {
                        showNotification('File non valido - formato dati non riconosciuto', 'error');
                    }
                } catch (error) {
                    console.error('Errore importazione:', error);
                    showNotification('Errore nella lettura del file', 'error');
                }
            };
            reader.readAsText(file);
            event.target.value = '';
        }

        // ======= UTILITY E NOTIFICHE =======
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.animation = 'slideOutRight 0.3s ease forwards';
                setTimeout(() => {
                    if (document.body.contains(notification)) {
                        document.body.removeChild(notification);
                    }
                }, 300);
            }, 4000);
        }

        // Cleanup e gestione eventi
        window.addEventListener('beforeunload', function() {
            if (isScanning) {
                stopScanner();
            }
            if (ocrWorker) {
                ocrWorker.terminate();
            }
        });

        // Gestione errori globali
        window.addEventListener('error', function(e) {
            console.error('Errore applicazione:', e.error);
            showNotification('Si √® verificato un errore inatteso', 'error');
        });

        // Service Worker per cache offline (opzionale)
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', function() {
                navigator.serviceWorker.register('/sw.js').then(function(registration) {
                    console.log('ServiceWorker registrato:', registration.scope);
                }, function(err) {
                    console.log('ServiceWorker registrazione fallita:', err);
                });
            });
        }
        // BUGFIX: Improved barcode & OCR accuracy (v4.2)
    </script>
</body>
</html>
