<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OfferteMax v4.0 - OCR Reale + Scanner Avanzato</title>
    <meta name="theme-color" content="#667eea">
    <meta name="description" content="Scanner barcode + OCR Volantini + API Supermercati per risparmiare sulla spesa">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tesseract.js/4.1.1/tesseract.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(45deg, #ff6b6b, #ee5a24);
            color: white;
            padding: 30px 20px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            font-weight: 700;
        }
        
        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }
        
        .main-content {
            padding: 30px 20px;
        }
        
        .section {
            margin-bottom: 40px;
            padding: 25px;
            border-radius: 15px;
            background: linear-gradient(145deg, #f8f9fa, #e9ecef);
            box-shadow: 0 8px 25px rgba(0,0,0,0.05);
        }
        
        .section h2 {
            color: #2c3e50;
            margin-bottom: 20px;
            font-size: 1.6em;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .add-product-form {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .add-product-form input, .add-product-form select {
            padding: 12px 15px;
            border: 2px solid #ddd;
            border-radius: 10px;
            font-size: 16px;
            transition: all 0.3s ease;
        }
        
        .add-product-form input:focus, .add-product-form select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .btn {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
            text-align: center;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }
        
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        
        .btn-scan {
            background: linear-gradient(45deg, #27ae60, #2ecc71);
            grid-column: span 3;
            margin-bottom: 15px;
        }
        
        .btn-scan:hover {
            box-shadow: 0 10px 20px rgba(39, 174, 96, 0.3);
        }
        
        .btn-add {
            grid-column: span 3;
        }
        
        .scanner-container {
            display: none;
            margin: 20px 0;
            border-radius: 15px;
            overflow: hidden;
            background: #000;
            position: relative;
        }
        
        .scanner-container.active {
            display: block;
        }
        
        #scanner-preview {
            width: 100%;
            height: 300px;
            object-fit: cover;
        }
        
        .scanner-overlay {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 200px;
            height: 100px;
            border: 2px solid #27ae60;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(39, 174, 96, 0.5);
        }
        
        .scanner-controls {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 15px;
        }
        
        .barcode-result {
            background: linear-gradient(45deg, #27ae60, #2ecc71);
            color: white;
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            display: none;
            align-items: center;
            gap: 15px;
        }
        
        .barcode-result.show {
            display: flex;
        }
        
        .barcode-info {
            flex: 1;
        }
        
        .barcode-code {
            font-family: 'Courier New', monospace;
            font-size: 1.1em;
            font-weight: 700;
        }
        
        .barcode-name {
            font-size: 0.9em;
            opacity: 0.9;
            margin-top: 5px;
        }
        
        .products-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .product-card {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
            border-left: 4px solid;
            transition: all 0.3s ease;
        }
        
        .product-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 30px rgba(0,0,0,0.15);
        }
        
        .product-card.best-offer {
            border-left-color: #27ae60;
            background: linear-gradient(135deg, #a8e6cf, #dcedc1);
        }
        
        .product-card.normal-offer {
            border-left-color: #f39c12;
        }
        
        .product-card.expensive {
            border-left-color: #e74c3c;
            background: linear-gradient(135deg, #ff9a9e, #fecfef);
        }
        
        .product-name {
            font-size: 1.3em;
            font-weight: 700;
            margin-bottom: 10px;
        }
        
        .product-details {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .price {
            font-size: 1.5em;
            font-weight: 700;
        }
        
        .supermarket {
            background: rgba(255,255,255,0.8);
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: 600;
            color: #2c3e50;
        }
        
        .savings {
            background: #27ae60;
            color: white;
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 600;
            text-align: center;
            margin-top: 10px;
            display: inline-block;
            margin-right: 5px;
        }
        
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 30px;
        }
        
        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
        }
        
        .stat-number {
            font-size: 2em;
            font-weight: 700;
            color: #667eea;
        }
        
        .stat-label {
            color: #666;
            margin-top: 5px;
        }
        
        .charts-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 30px;
            margin-top: 20px;
        }
        
        .chart-card {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
        }
        
        .chart-card h3 {
            color: #2c3e50;
            margin-bottom: 20px;
            font-size: 1.3em;
        }
        
        .chart-container {
            position: relative;
            height: 300px;
        }

        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
            margin-right: 10px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        @keyframes slideInRight {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        @keyframes slideOutRight {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(100%); opacity: 0; }
        }

        .flyer-analysis {
            background: rgba(52, 152, 219, 0.1);
            border-radius: 10px;
            padding: 15px;
            margin: 15px 0;
            border-left: 4px solid #3498db;
        }

        .ocr-progress {
            background: rgba(39, 174, 96, 0.1);
            border: 1px solid #27ae60;
            border-radius: 10px;
            padding: 15px;
            margin: 15px 0;
            display: none;
        }

        .ocr-progress.show {
            display: block;
        }

        .progress-bar {
            background: #ecf0f1;
            border-radius: 10px;
            height: 10px;
            overflow: hidden;
            margin: 10px 0;
        }

        .progress-fill {
            background: linear-gradient(45deg, #27ae60, #2ecc71);
            height: 100%;
            width: 0%;
            transition: width 0.3s ease;
        }

        .ocr-text-display {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
            max-height: 200px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            white-space: pre-wrap;
        }

        @media (max-width: 768px) {
            .add-product-form {
                grid-template-columns: 1fr;
            }
            
            .btn-scan, .btn-add {
                grid-column: span 1;
            }
            
            .header h1 {
                font-size: 2em;
            }
            
            .charts-container {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🛒 OfferteMax v4.0</h1>
            <p>OCR Reale + Scanner Barcode + Confronto Prezzi</p>
        </div>
        
        <div class="main-content">
            <!-- SEZIONE OCR VOLANTINI -->
            <div class="section">
                <h2>📖 OCR Scanner Volantini</h2>
                <div class="flyer-analysis">
                    <strong>🔍 Riconoscimento OCR Reale:</strong><br>
                    • Usa Tesseract.js per estrarre testo dalle immagini<br>
                    • Riconosce prezzi, prodotti e supermercati automaticamente<br>
                    • Supporta immagini JPG, PNG e documenti scansionati<br>
                    • Analizza pattern di offerte comuni nei volantini italiani
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; margin-bottom: 20px;">
                    <label class="btn" style="background: linear-gradient(45deg, #3498db, #2980b9); cursor: pointer; text-align: center;">
                        📷 Scatta Foto
                        <input type="file" accept="image/*" capture="camera" onchange="processOCRFlyer(event)" style="display: none;">
                    </label>
                    <label class="btn" style="background: linear-gradient(45deg, #9b59b6, #8e44ad); cursor: pointer; text-align: center;">
                        🖼️ Carica Immagine
                        <input type="file" accept="image/*" onchange="processOCRFlyer(event)" style="display: none;">
                    </label>
                    <button class="btn" onclick="showFlyerSources()" style="background: linear-gradient(45deg, #3498db, #2980b9);">
                        🌐 Trova Volantini
                    </button>
                </div>
                
                <div id="ocrProgress" class="ocr-progress">
                    <div id="ocrStatus">🔍 Inizializzazione OCR...</div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="ocrProgressBar"></div>
                    </div>
                    <div id="ocrDetails" style="font-size: 0.8em; color: #666; margin-top: 5px;"></div>
                </div>
                
                <div id="flyerPreview" style="display: none; margin: 20px 0; text-align: center;">
                    <img id="flyerImage" style="max-width: 100%; max-height: 300px; border-radius: 10px; box-shadow: 0 5px 15px rgba(0,0,0,0.2);">
                    <div style="margin-top: 10px;">
                        <button class="btn" onclick="startOCRAnalysis()" style="background: linear-gradient(45deg, #27ae60, #2ecc71);" id="analyzeOCRBtn">
                            🔍 Avvia OCR
                        </button>
                        <button class="btn" onclick="clearFlyerPreview()" style="background: linear-gradient(45deg, #e74c3c, #c0392b);">
                            ❌ Rimuovi
                        </button>
                    </div>
                </div>
                
                <div id="ocrTextDisplay" class="ocr-text-display" style="display: none;"></div>
                
                <div id="flyerResults" style="display: none; margin-top: 20px;">
                    <h3 style="color: #2c3e50; margin-bottom: 15px;">🎯 Offerte Estratte dall'OCR:</h3>
                    <div id="extractedOffers" class="products-grid"></div>
                    <div style="text-align: center; margin-top: 20px;">
                        <button class="btn" onclick="addAllExtractedOffers()" style="background: linear-gradient(45deg, #27ae60, #2ecc71);">
                            ✅ Aggiungi Tutte le Offerte
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- SEZIONE FILTRI -->
            <div class="section">
                <h2>🔍 Filtri e Ricerca</h2>
                <div style="display: flex; gap: 15px; flex-wrap: wrap; align-items: center;">
                    <input type="text" id="searchInput" placeholder="🔍 Cerca prodotti..." style="flex: 1; min-width: 200px; padding: 12px 15px; border: 2px solid #ddd; border-radius: 10px; font-size: 16px;">
                    <select id="supermarketFilter" style="padding: 12px 15px; border: 2px solid #ddd; border-radius: 10px; font-size: 16px;">
                        <option value="">Tutti i supermercati</option>
                        <option value="Conad">Conad</option>
                        <option value="Coop">Coop</option>
                        <option value="Esselunga">Esselunga</option>
                        <option value="Carrefour">Carrefour</option>
                        <option value="Lidl">Lidl</option>
                        <option value="MD">MD</option>
                        <option value="Eurospin">Eurospin</option>
                        <option value="Penny">Penny</option>
                        <option value="Altro">Altro</option>
                    </select>
                </div>
            </div>
            
            <!-- SEZIONE AGGIUNGI PRODOTTO -->
            <div class="section">
                <h2>📱 Scanner Barcode</h2>
                
                <!-- Barcode Scanner -->
                <button class="btn btn-scan" onclick="toggleScanner()">
                    📷 Scansiona Codice a Barre
                </button>
                
                <div style="margin: 15px 0; padding: 15px; background: rgba(39, 174, 96, 0.1); border-radius: 10px; border-left: 4px solid #27ae60;">
                    <strong>🌐 API OpenFoodFacts Integrata:</strong><br>
                    • Database mondiale con milioni di prodotti<br>
                    • Riconoscimento automatico nome, marca e dimensioni<br>
                    • Supporta EAN-13, EAN-8, UPC-A e altri formati<br>
                    • Funziona anche offline per codici comuni
                </div>
                
                <div class="scanner-container" id="scannerContainer">
                    <div id="scanner-preview"></div>
                    <div class="scanner-overlay"></div>
                    <div class="scanner-controls">
                        <button class="btn" onclick="stopScanner()">❌ Chiudi</button>
                    </div>
                </div>
                
                <div class="barcode-result" id="barcodeResult">
                    <div class="barcode-info">
                        <div class="barcode-code" id="barcodeCode"></div>
                        <div class="barcode-name" id="barcodeName">Prodotto riconosciuto!</div>
                    </div>
                    <button class="btn" onclick="useBarcodeResult()">✅ Usa</button>
                </div>
                
                <!-- Form tradizionale -->
                <div class="add-product-form">
                    <input type="text" id="productName" placeholder="Nome prodotto" />
                    <input type="number" id="productPrice" placeholder="Prezzo €" step="0.01" />
                    <select id="supermarketSelect">
                        <option value="">Seleziona supermercato</option>
                        <option value="Conad">Conad</option>
                        <option value="Coop">Coop</option>
                        <option value="Esselunga">Esselunga</option>
                        <option value="Carrefour">Carrefour</option>
                        <option value="Lidl">Lidl</option>
                        <option value="MD">MD</option>
                        <option value="Eurospin">Eurospin</option>
                        <option value="Penny">Penny</option>
                        <option value="Altro">Altro</option>
                    </select>
                    <button class="btn btn-add" onclick="addProduct()">➕ Aggiungi Offerta</button>
                </div>
                
                <div style="display: flex; gap: 10px; margin-top: 15px; flex-wrap: wrap;">
                    <button class="btn" style="background: linear-gradient(45deg, #e74c3c, #c0392b); flex: 1;" onclick="clearAllData()">🗑️ Cancella Tutto</button>
                    <button class="btn" style="background: linear-gradient(45deg, #27ae60, #2ecc71); flex: 1;" onclick="exportData()">📤 Esporta Dati</button>
                    <label class="btn" style="background: linear-gradient(45deg, #3498db, #2980b9); flex: 1; cursor: pointer;">
                        📥 Importa Dati
                        <input type="file" accept=".json" onchange="importData(event)" style="display: none;">
                    </label>
                </div>
            </div>
            
            <!-- SEZIONE ANALYTICS -->
            <div class="section">
                <h2>📊 Analytics Famiglia</h2>
                <div class="charts-container">
                    <div class="chart-card">
                        <h3>🏆 Supermercati Più Convenienti</h3>
                        <div class="chart-container">
                            <canvas id="supermarketChart"></canvas>
                        </div>
                    </div>
                    <div class="chart-card">
                        <h3>💰 Distribuzione Prezzi</h3>
                        <div class="chart-container">
                            <canvas id="priceDistributionChart"></canvas>
                        </div>
                    </div>
                    <div class="chart-card">
                        <h3>📈 Trend Prezzi nel Tempo</h3>
                        <div class="chart-container">
                            <canvas id="priceTimeChart"></canvas>
                        </div>
                    </div>
                    <div class="chart-card">
                        <h3>🛍️ Prodotti Più Tracciati</h3>
                        <div class="chart-container">
                            <canvas id="topProductsChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- SEZIONE PRODOTTI -->
            <div class="section">
                <h2>🏆 Migliori Offerte</h2>
                <div id="productsContainer" class="products-grid">
                    <!-- I prodotti verranno aggiunti dinamicamente qui -->
                </div>
            </div>
            
            <!-- SEZIONE STATISTICHE -->
            <div class="section">
                <h2>📊 Statistiche</h2>
                <div class="stats">
                    <div class="stat-card">
                        <div class="stat-number" id="totalProducts">0</div>
                        <div class="stat-label">Prodotti Tracciati</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="totalSavings">€0</div>
                        <div class="stat-label">Risparmio Totale</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="avgSavings">0%</div>
                        <div class="stat-label">Risparmio Medio</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="bestSupermarket">-</div>
                        <div class="stat-label">Supermercato Top</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ====================== VARIABILI GLOBALI ======================
        let products = [];
        let charts = {};
        let isScanning = false;
        let currentBarcode = null;
        let currentFlyerImage = null;
        let extractedOffers = [];
        let ocrWorker = null;

        // ====================== INIZIALIZZAZIONE ======================
        document.addEventListener('DOMContentLoaded', function() {
            loadFromLocalStorage();
            renderProducts();
            updateStats();
            updateCharts();
            setupEventListeners();
            showNotification('📱 Scanner fermato', 'info');
        }

        async function onBarcodeDetected(result) {
            const code = result.codeResult.code;
            
            if (!code || code.length < 8) {
                return;
            }
            
            if (currentBarcode === code) {
                return;
            }
            
            if (!/^\d+$/.test(code)) {
                return;
            }
            
            currentBarcode = code;
            
            stopScanner();
            
            showNotification('🔍 Codice rilevato! Ricerca in corso...', 'info');
            
            const productInfo = await getProductFromBarcode(code);
            
            document.getElementById('barcodeCode').textContent = code;
            document.getElementById('barcodeName').textContent = productInfo.name;
            document.getElementById('barcodeResult').classList.add('show');
            
            if (navigator.vibrate) {
                navigator.vibrate([100, 50, 100]);
            }
            
            if (productInfo.name && !productInfo.name.startsWith('Prodotto ')) {
                setTimeout(() => {
                    document.getElementById('productName').value = productInfo.name;
                    document.getElementById('productPrice').focus();
                }, 1000);
            }
        }

        async function useBarcodeResult() {
            if (currentBarcode) {
                const productInfo = await getProductFromBarcode(currentBarcode);
                document.getElementById('productName').value = productInfo.name;
                document.getElementById('barcodeResult').classList.remove('show');
                
                document.getElementById('productPrice').focus();
                showNotification('✅ Nome prodotto copiato nel form!', 'success');
            }
        }

        // ====================== GESTIONE PRODOTTI ======================
        function addProduct() {
            const name = document.getElementById('productName').value.trim();
            const price = parseFloat(document.getElementById('productPrice').value);
            const supermarket = document.getElementById('supermarketSelect').value;
            
            if (!name || !price || !supermarket) {
                showNotification('⚠️ Compila tutti i campi!', 'warning');
                return;
            }
            
            if (price <= 0) {
                showNotification('⚠️ Il prezzo deve essere maggiore di zero!', 'warning');
                return;
            }
            
            const existingProductIndex = products.findIndex(p => 
                p.name.toLowerCase().includes(name.toLowerCase()) ||
                name.toLowerCase().includes(p.name.toLowerCase())
            );
            
            if (existingProductIndex !== -1) {
                const existingProduct = products[existingProductIndex];
                
                if (!existingProduct.offers) {
                    existingProduct.offers = [{ 
                        price: existingProduct.price || price, 
                        supermarket: existingProduct.supermarket || supermarket, 
                        date: existingProduct.date || new Date()
                    }];
                    delete existingProduct.price;
                    delete existingProduct.supermarket;
                    delete existingProduct.date;
                }
                
                existingProduct.offers.push({
                    price: price,
                    supermarket: supermarket,
                    date: new Date()
                });
                
                showNotification(`✅ Nuova offerta aggiunta per ${name}!`, 'success');
            } else {
                const newProduct = {
                    id: Date.now(),
                    name: name,
                    offers: [{
                        price: price,
                        supermarket: supermarket,
                        date: new Date()
                    }]
                };
                
                products.push(newProduct);
                showNotification(`✅ Prodotto "${name}" aggiunto!`, 'success');
            }
            
            document.getElementById('productName').value = '';
            document.getElementById('productPrice').value = '';
            document.getElementById('supermarketSelect').value = '';
            document.getElementById('barcodeResult').classList.remove('show');
            currentBarcode = null;
            
            renderProducts();
            updateStats();
            updateCharts();
            saveToLocalStorage();
        }

        function renderProducts() {
            const container = document.getElementById('productsContainer');
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const supermarketFilter = document.getElementById('supermarketFilter').value;
            
            let filteredProducts = products.filter(product => {
                const matchesSearch = product.name.toLowerCase().includes(searchTerm);
                const matchesSupermarket = !supermarketFilter || 
                    (product.offers && product.offers.some(offer => offer.supermarket === supermarketFilter)) ||
                    (product.supermarket === supermarketFilter);
                
                return matchesSearch && matchesSupermarket;
            });
            
            if (filteredProducts.length === 0) {
                container.innerHTML = '<div style="text-align: center; padding: 40px; color: #666;">Nessun prodotto trovato. Inizia aggiungendo i tuoi primi prodotti!</div>';
                return;
            }
            
            container.innerHTML = '';
            
            filteredProducts.forEach(product => {
                const productCard = createProductCard(product);
                container.appendChild(productCard);
            });
        }

        function createProductCard(product) {
            const card = document.createElement('div');
            
            let bestOffer, averagePrice, savings;
            
            if (product.offers && product.offers.length > 0) {
                bestOffer = product.offers.reduce((best, current) => 
                    current.price < best.price ? current : best
                );
                averagePrice = product.offers.reduce((sum, offer) => sum + offer.price, 0) / product.offers.length;
                savings = averagePrice - bestOffer.price;
            } else {
                bestOffer = { 
                    price: product.price, 
                    supermarket: product.supermarket, 
                    date: product.date || new Date()
                };
                averagePrice = product.price;
                savings = 0;
            }
            
            let cardClass = 'normal-offer';
            if (savings > 2) {
                cardClass = 'best-offer';
            } else if (savings < -1) {
                cardClass = 'expensive';
            }
            
            card.className = `product-card ${cardClass}`;
            
            const offersCount = product.offers ? product.offers.length : 1;
            const savingsPercentage = averagePrice > 0 ? ((savings / averagePrice) * 100).toFixed(1) : 0;
            
            card.innerHTML = `
                <div class="product-name">${product.name}</div>
                <div class="product-details">
                    <div>
                        ${averagePrice !== bestOffer.price ? 
                            `<span style="text-decoration: line-through; color: #999; font-size: 0.9em;">€${averagePrice.toFixed(2)}</span>` : ''
                        }
                        <span class="price" style="color: #27ae60; ${averagePrice !== bestOffer.price ? 'margin-left: 10px;' : ''}">€${bestOffer.price.toFixed(2)}</span>
                    </div>
                    <div class="supermarket">${bestOffer.supermarket}</div>
                </div>
                ${offersCount > 1 ? `
                <div style="font-size: 0.85em; color: #666; margin: 5px 0;">
                    ${offersCount} offerte trovate
                </div>` : ''}
                ${savings > 0 ? `
                <div class="savings">Risparmi €${savings.toFixed(2)} (${savingsPercentage}%)</div>` : ''}
                <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 15px; gap: 10px;">
                    <button class="btn" onclick="showProductDetails(${product.id})" style="background: linear-gradient(45deg, #3498db, #2980b9); padding: 8px 15px; font-size: 0.9em; flex: 1;">
                        📊 Dettagli
                    </button>
                    <button class="btn" onclick="deleteProduct(${product.id})" style="background: linear-gradient(45deg, #e74c3c, #c0392b); padding: 8px 15px; font-size: 0.9em;">
                        🗑️
                    </button>
                </div>
            `;
            
            return card;
        }

        function showProductDetails(productId) {
            const product = products.find(p => p.id === productId);
            if (!product) return;
            
            let detailsHTML = `
                <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; display: flex; justify-content: center; align-items: center;" onclick="closeProductDetails()">
                    <div style="background: white; padding: 30px; border-radius: 15px; max-width: 600px; max-height: 80vh; overflow-y: auto; box-shadow: 0 20px 40px rgba(0,0,0,0.3);" onclick="event.stopPropagation()">
                        <h2 style="color: #2c3e50; margin-bottom: 20px;">${product.name}</h2>
            `;
            
            if (product.offers && product.offers.length > 0) {
                detailsHTML += '<h3 style="color: #27ae60; margin-bottom: 15px;">Storico Offerte:</h3>';
                const sortedOffers = [...product.offers].sort((a, b) => new Date(b.date) - new Date(a.date));
                
                sortedOffers.forEach(offer => {
                    const dateStr = new Date(offer.date).toLocaleDateString('it-IT');
                    const ocrBadge = offer.fromOCR ? `<span style="background: #3498db; color: white; padding: 2px 6px; border-radius: 10px; font-size: 0.7em; margin-left: 10px;">OCR</span>` : '';
                    
                    detailsHTML += `
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px; border: 1px solid #ddd; border-radius: 8px; margin: 5px 0;">
                            <div>
                                <strong>€${offer.price.toFixed(2)}</strong> - ${offer.supermarket}
                                ${ocrBadge}
                                ${offer.ocrConfidence ? `<span style="color: #666; font-size: 0.8em;">(${(offer.ocrConfidence * 100).toFixed(0)}%)</span>` : ''}
                            </div>
                            <div style="color: #666; font-size: 0.9em;">${dateStr}</div>
                        </div>
                    `;
                });
            } else {
                detailsHTML += `
                    <div style="padding: 20px; background: #f8f9fa; border-radius: 10px; text-align: center; color: #666;">
                        Nessuna offerta disponibile
                    </div>
                `;
            }
            
            detailsHTML += `
                        <div style="text-align: center; margin-top: 20px;">
                            <button class="btn" onclick="closeProductDetails()" style="background: linear-gradient(45deg, #95a5a6, #7f8c8d);">
                                ❌ Chiudi
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            const modal = document.createElement('div');
            modal.id = 'productModal';
            modal.innerHTML = detailsHTML;
            document.body.appendChild(modal);
        }

        function closeProductDetails() {
            const modal = document.getElementById('productModal');
            if (modal) {
                document.body.removeChild(modal);
            }
        }

        function deleteProduct(productId) {
            if (confirm('Sei sicuro di voler eliminare questo prodotto?')) {
                products = products.filter(p => p.id !== productId);
                renderProducts();
                updateStats();
                updateCharts();
                saveToLocalStorage();
                showNotification('🗑️ Prodotto eliminato', 'info');
            }
        }

        // ====================== STATISTICHE E CHARTS ======================
        function updateStats() {
            const totalProducts = products.length;
            let totalSavings = 0;
            let savingsCount = 0;
            const supermarketCounts = {};
            
            products.forEach(product => {
                if (product.offers && product.offers.length > 1) {
                    const prices = product.offers.map(o => o.price);
                    const minPrice = Math.min(...prices);
                    const avgPrice = prices.reduce((a, b) => a + b, 0) / prices.length;
                    totalSavings += avgPrice - minPrice;
                    savingsCount++;
                }
                
                if (product.offers) {
                    product.offers.forEach(offer => {
                        supermarketCounts[offer.supermarket] = (supermarketCounts[offer.supermarket] || 0) + 1;
                    });
                } else if (product.supermarket) {
                    supermarketCounts[product.supermarket] = (supermarketCounts[product.supermarket] || 0) + 1;
                }
            });
            
            const avgSavingsPercent = savingsCount > 0 ? (totalSavings / savingsCount / 10 * 100).toFixed(1) : 0;
            const bestSupermarket = Object.keys(supermarketCounts).reduce((a, b) => 
                supermarketCounts[a] > supermarketCounts[b] ? a : b, '-');
            
            document.getElementById('totalProducts').textContent = totalProducts;
            document.getElementById('totalSavings').textContent = '€' + totalSavings.toFixed(2);
            document.getElementById('avgSavings').textContent = avgSavingsPercent + '%';
            document.getElementById('bestSupermarket').textContent = bestSupermarket;
        }

        function updateCharts() {
            updateSupermarketChart();
            updatePriceDistributionChart();
            updatePriceTimeChart();
            updateTopProductsChart();
        }

        function updateSupermarketChart() {
            const ctx = document.getElementById('supermarketChart').getContext('2d');
            
            if (charts.supermarket) {
                charts.supermarket.destroy();
            }
            
            const supermarketData = {};
            const supermarketPrices = {};
            
            products.forEach(product => {
                if (product.offers) {
                    product.offers.forEach(offer => {
                        if (!supermarketData[offer.supermarket]) {
                            supermarketData[offer.supermarket] = 0;
                            supermarketPrices[offer.supermarket] = [];
                        }
                        supermarketData[offer.supermarket]++;
                        supermarketPrices[offer.supermarket].push(offer.price);
                    });
                }
            });
            
            const labels = Object.keys(supermarketData);
            const averagePrices = labels.map(market => {
                const prices = supermarketPrices[market];
                return prices.reduce((a, b) => a + b, 0) / prices.length;
            });
            
            charts.supermarket = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Prezzo Medio €',
                        data: averagePrices,
                        backgroundColor: 'rgba(39, 174, 96, 0.8)',
                        borderColor: 'rgba(39, 174, 96, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return '€' + value.toFixed(2);
                                }
                            }
                        }
                    }
                }
            });
        }

        function updatePriceDistributionChart() {
            const ctx = document.getElementById('priceDistributionChart').getContext('2d');
            
            if (charts.priceDistribution) {
                charts.priceDistribution.destroy();
            }
            
            const prices = [];
            products.forEach(product => {
                if (product.offers) {
                    product.offers.forEach(offer => prices.push(offer.price));
                }
            });
            
            const ranges = ['0-2€', '2-5€', '5-10€', '10-20€', '20€+'];
            const counts = [0, 0, 0, 0, 0];
            
            prices.forEach(price => {
                if (price < 2) counts[0]++;
                else if (price < 5) counts[1]++;
                else if (price < 10) counts[2]++;
                else if (price < 20) counts[3]++;
                else counts[4]++;
            });
            
            charts.priceDistribution = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ranges,
                    datasets: [{
                        data: counts,
                        backgroundColor: [
                            'rgba(46, 204, 113, 0.8)',
                            'rgba(52, 152, 219, 0.8)',
                            'rgba(155, 89, 182, 0.8)',
                            'rgba(243, 156, 18, 0.8)',
                            'rgba(231, 76, 60, 0.8)'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false
                }
            });
        }

        function updatePriceTimeChart() {
            const ctx = document.getElementById('priceTimeChart').getContext('2d');
            
            if (charts.priceTime) {
                charts.priceTime.destroy();
            }
            
            const timeData = {};
            products.forEach(product => {
                if (product.offers) {
                    product.offers.forEach(offer => {
                        const date = new Date(offer.date).toLocaleDateString('it-IT');
                        if (!timeData[date]) timeData[date] = [];
                        timeData[date].push(offer.price);
                    });
                }
            });
            
            const sortedDates = Object.keys(timeData).sort((a, b) => new Date(a) - new Date(b));
            const averagePrices = sortedDates.map(date => {
                const prices = timeData[date];
                return prices.reduce((a, b) => a + b, 0) / prices.length;
            });
            
            charts.priceTime = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: sortedDates.slice(-10),
                    datasets: [{
                        label: 'Prezzo Medio €',
                        data: averagePrices.slice(-10),
                        borderColor: 'rgba(52, 152, 219, 1)',
                        backgroundColor: 'rgba(52, 152, 219, 0.1)',
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return '€' + value.toFixed(2);
                                }
                            }
                        }
                    }
                }
            });
        }

        function updateTopProductsChart() {
            const ctx = document.getElementById('topProductsChart').getContext('2d');
            
            if (charts.topProducts) {
                charts.topProducts.destroy();
            }
            
            const productCounts = {};
            products.forEach(product => {
                const offerCount = product.offers ? product.offers.length : 1;
                productCounts[product.name] = offerCount;
            });
            
            const sortedProducts = Object.entries(productCounts)
                .sort(([,a], [,b]) => b - a)
                .slice(0, 5);
            
            charts.topProducts = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: sortedProducts.map(([name]) => name.length > 15 ? name.substring(0, 15) + '...' : name),
                    datasets: [{
                        label: 'Offerte Trovate',
                        data: sortedProducts.map(([, count]) => count),
                        backgroundColor: 'rgba(155, 89, 182, 0.8)',
                        borderColor: 'rgba(155, 89, 182, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            }
                        }
                    }
                }
            });
        }

        // ====================== STORAGE ======================
        function saveToLocalStorage() {
            try {
                const dataToSave = {
                    products: products,
                    version: '4.0',
                    lastSaved: new Date().toISOString()
                };
                localStorage.setItem('offertemax_data', JSON.stringify(dataToSave));
            } catch (error) {
                console.error('Errore salvataggio:', error);
                showNotification('⚠️ Errore nel salvataggio dati', 'warning');
            }
        }

        function loadFromLocalStorage() {
            try {
                const savedData = localStorage.getItem('offertemax_data');
                if (savedData) {
                    const parsed = JSON.parse(savedData);
                    products = parsed.products || [];
                    showNotification(`📥 Caricati ${products.length} prodotti salvati`, 'success');
                }
            } catch (error) {
                console.error('Errore caricamento:', error);
                products = [];
                showNotification('⚠️ Errore nel caricamento dati', 'warning');
            }
        }

        function clearAllData() {
            if (confirm('Sei sicuro di voler cancellare tutti i dati? Questa operazione non è reversibile.')) {
                products = [];
                localStorage.removeItem('offertemax_data');
                renderProducts();
                updateStats();
                updateCharts();
                showNotification('🗑️ Tutti i dati cancellati', 'info');
            }
        }

        function exportData() {
            try {
                const dataToExport = {
                    products: products,
                    exportDate: new Date().toISOString(),
                    version: '4.0'
                };
                
                const blob = new Blob([JSON.stringify(dataToExport, null, 2)], {
                    type: 'application/json'
                });
                
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `offertemax_backup_${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                showNotification('📤 Dati esportati con successo!', 'success');
            } catch (error) {
                console.error('Errore esportazione:', error);
                showNotification('❌ Errore nell\'esportazione', 'warning');
            }
        }

        function importData(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const importedData = JSON.parse(e.target.result);
                    
                    if (importedData.products && Array.isArray(importedData.products)) {
                        if (confirm(`Importare ${importedData.products.length} prodotti? I dati attuali verranno sostituiti.`)) {
                            products = importedData.products;
                            renderProducts();
                            updateStats();
                            updateCharts();
                            saveToLocalStorage();
                            showNotification(`📥 ${products.length} prodotti importati!`, 'success');
                        }
                    } else {
                        showNotification('❌ File non valido', 'warning');
                    }
                } catch (error) {
                    console.error('Errore importazione:', error);
                    showNotification('❌ Errore nel file importato', 'warning');
                }
            };
            reader.readAsText(file);
            event.target.value = '';
        }

        // ====================== UTILITY ======================
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            const bgColor = type === 'success' ? '#27ae60' : type === 'warning' ? '#f39c12' : '#3498db';
            
            notification.style.cssText = `
                position: fixed; 
                top: 20px; 
                right: 20px; 
                background: ${bgColor}; 
                color: white; 
                padding: 15px 20px; 
                border-radius: 10px; 
                z-index: 1000; 
                box-shadow: 0 5px 15px rgba(0,0,0,0.3);
                animation: slideInRight 0.3s ease forwards;
                max-width: 300px;
                font-size: 0.9em;
            `;
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.animation = 'slideOutRight 0.3s ease forwards';
                setTimeout(() => {
                    if (document.body.contains(notification)) {
                        document.body.removeChild(notification);
                    }
                }, 300);
            }, 4000);
        }

        // ====================== CLEANUP ON PAGE UNLOAD ======================
        window.addEventListener('beforeunload', function() {
            if (ocrWorker) {
                ocrWorker.terminate();
            }
            if (isScanning) {
                stopScanner();
            }
        });
    </script>
</body>
</html>ification('🚀 OfferteMax v4.0 caricato!', 'success');
        });

        function setupEventListeners() {
            document.getElementById('searchInput').addEventListener('input', renderProducts);
            document.getElementById('supermarketFilter').addEventListener('change', renderProducts);
        }

        // ====================== VOLANTINI REALI - SOSTITUZIONE API ======================
        function showFlyerSources() {
            const modal = document.createElement('div');
            modal.id = 'flyerSourceModal';
            modal.innerHTML = `
                <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; display: flex; justify-content: center; align-items: center;" onclick="closeFlyerSources()">
                    <div style="background: white; padding: 30px; border-radius: 15px; max-width: 600px; max-height: 80vh; overflow-y: auto; box-shadow: 0 20px 40px rgba(0,0,0,0.3); margin: 20px;" onclick="event.stopPropagation()">
                        <h2 style="color: #2c3e50; margin-bottom: 20px; text-align: center;">🌐 Dove Trovare i Volantini</h2>
                        
                        <div style="margin-bottom: 20px; padding: 15px; background: rgba(231, 76, 60, 0.1); border-radius: 10px; border-left: 4px solid #e74c3c;">
                            <strong>⚠️ Perché Non Ci Sono API:</strong><br>
                            • I supermercati proteggono i loro dati commerciali<br>
                            • Le offerte cambiano dinamicamente per strategia<br>
                            • Questioni legali e di concorrenza<br>
                            • Solo aggregatori terzi raccolgono manualmente i dati
                        </div>
                        
                        <div style="text-align: center; margin-top: 25px;">
                            <button class="btn" onclick="closeFlyerSources()" style="background: linear-gradient(45deg, #95a5a6, #7f8c8d); margin-right: 10px;">
                                ❌ Chiudi
                            </button>
                            <button class="btn" onclick="openOfficialSites()" style="background: linear-gradient(45deg, #27ae60, #2ecc71);">
                                🌐 Vai a DoveConviene
                            </button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function closeFlyerSources() {
            const modal = document.getElementById('flyerSourceModal');
            if (modal) {
                document.body.removeChild(modal);
            }
        }

        function openOfficialSites() {
            window.open('https://www.doveconviene.it/iper-e-super', '_blank');
            closeFlyerSources();
            showNotification('🌐 Aperto DoveConviene - Scarica volantini e usa l\'OCR!', 'info');
        }

        // ====================== INIZIALIZZAZIONE OCR ======================
        async function initOCR() {
            try {
                showNotification('🔧 Inizializzazione Tesseract.js...', 'info');
                ocrWorker = await Tesseract.createWorker('ita+eng', 1, {
                    logger: m => {
                        if (m.status === 'recognizing text') {
                            updateOCRProgress(Math.round(m.progress * 100), `Riconoscimento testo: ${Math.round(m.progress * 100)}%`);
                        }
                    }
                });
                
                await ocrWorker.setParameters({
                    tessedit_char_whitelist: '0123456789.,€ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyzàèéìíîïòóôùúûüç%- ',
                    tessedit_pageseg_mode: Tesseract.PSM.AUTO
                });
                
                showNotification('✅ OCR Tesseract.js pronto!', 'success');
                return true;
            } catch (error) {
                console.error('Errore inizializzazione OCR:', error);
                showNotification('❌ Errore inizializzazione OCR', 'warning');
                return false;
            }
        }

        // ====================== API PRODOTTI REALE ======================
        async function getProductFromBarcode(barcode) {
            try {
                showNotification('🔍 Ricerca prodotto su OpenFoodFacts...', 'info');
                
                const response = await fetch(`https://world.openfoodfacts.org/api/v0/product/${barcode}.json`);
                const data = await response.json();
                
                if (data.status === 1 && data.product) {
                    const product = data.product;
                    let productName = '';
                    
                    productName = product.product_name_it || product.product_name || product.generic_name || '';
                    
                    if (product.brands) {
                        const brand = product.brands.split(',')[0].trim();
                        if (brand && !productName.toLowerCase().includes(brand.toLowerCase())) {
                            productName = `${brand} ${productName}`;
                        }
                    }
                    
                    if (product.quantity && !productName.includes(product.quantity)) {
                        productName += ` ${product.quantity}`;
                    }
                    
                    if (productName.trim()) {
                        showNotification(`✅ Prodotto trovato: ${productName}`, 'success');
                        return {
                            name: productName.trim(),
                            brand: product.brands ? product.brands.split(',')[0].trim() : '',
                            category: product.categories_hierarchy ? product.categories_hierarchy[product.categories_hierarchy.length - 1] : '',
                            image: product.image_url
                        };
                    }
                }
                
                showNotification('⚠️ Prodotto non trovato nel database', 'warning');
                return {
                    name: `Prodotto ${barcode}`,
                    brand: '',
                    category: '',
                    image: null
                };
                
            } catch (error) {
                console.error('Errore ricerca prodotto:', error);
                showNotification('⚠️ Ricerca online non disponibile', 'warning');
                return {
                    name: `Prodotto ${barcode}`,
                    brand: '',
                    category: '',
                    image: null
                };
            }
        }

        // ====================== OCR VOLANTINI REALE ======================
        function processOCRFlyer(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            if (file.size > 10 * 1024 * 1024) {
                showNotification('❌ Immagine troppo grande (max 10MB)', 'warning');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                currentFlyerImage = e.target.result;
                document.getElementById('flyerImage').src = currentFlyerImage;
                document.getElementById('flyerPreview').style.display = 'block';
                document.getElementById('flyerResults').style.display = 'none';
                document.getElementById('ocrTextDisplay').style.display = 'none';
                showNotification('📸 Immagine caricata! Pronto per l\'OCR', 'info');
            };
            reader.readAsDataURL(file);
            event.target.value = '';
        }

        function updateOCRProgress(percentage, status, details = '') {
            const progressContainer = document.getElementById('ocrProgress');
            const progressBar = document.getElementById('ocrProgressBar');
            const statusElement = document.getElementById('ocrStatus');
            const detailsElement = document.getElementById('ocrDetails');
            
            progressContainer.classList.add('show');
            progressBar.style.width = percentage + '%';
            statusElement.textContent = status;
            detailsElement.textContent = details;
        }

        async function startOCRAnalysis() {
            if (!currentFlyerImage) return;
            
            const analyzeBtn = document.getElementById('analyzeOCRBtn');
            const originalText = analyzeBtn.innerHTML;
            analyzeBtn.innerHTML = '<span class="loading-spinner"></span>Analisi OCR...';
            analyzeBtn.disabled = true;
            
            updateOCRProgress(0, '🚀 Avvio analisi OCR...', 'Preparazione immagine');
            
            try {
                if (!ocrWorker) {
                    updateOCRProgress(10, '🔧 Inizializzazione Tesseract...', 'Caricamento engine OCR');
                    const initialized = await initOCR();
                    if (!initialized) {
                        throw new Error('Impossibile inizializzare OCR');
                    }
                }
                
                updateOCRProgress(25, '📖 Riconoscimento testo in corso...', 'Scansione immagine');
                
                const { data: { text } } = await ocrWorker.recognize(currentFlyerImage);
                
                updateOCRProgress(75, '🔍 Analisi del testo estratto...', 'Ricerca offerte');
                
                document.getElementById('ocrTextDisplay').textContent = text;
                document.getElementById('ocrTextDisplay').style.display = 'block';
                
                const offers = await extractOffersFromOCRText(text);
                
                updateOCRProgress(100, '✅ Analisi completata!', `Trovate ${offers.length} offerte`);
                
                if (offers.length > 0) {
                    displayExtractedOffers(offers);
                    showNotification(`🎉 OCR completato! Trovate ${offers.length} offerte`, 'success');
                } else {
                    showNotification('⚠️ Nessuna offerta riconosciuta nel testo', 'warning');
                }
                
                setTimeout(() => {
                    document.getElementById('ocrProgress').classList.remove('show');
                }, 3000);
                
            } catch (error) {
                console.error('Errore OCR:', error);
                showNotification('❌ Errore durante l\'analisi OCR', 'warning');
                updateOCRProgress(0, '❌ Errore OCR', error.message);
            } finally {
                analyzeBtn.innerHTML = originalText;
                analyzeBtn.disabled = false;
            }
        }

        async function extractOffersFromOCRText(text) {
            const offers = [];
            const lines = text.split('\n').filter(line => line.trim().length > 2);
            
            const pricePattern = /€?\s*(\d+)[,.](\d{2})\s*€?/g;
            const percentPattern = /(\d+)%/g;
            const productPatterns = [
                /pasta\s+[a-zA-Z]+/gi,
                /latte\s+[a-zA-Z]+/gi,
                /olio\s+[a-zA-Z]+/gi,
                /parmigiano\s+[a-zA-Z]*/gi,
                /yogurt\s+[a-zA-Z]*/gi,
                /pane\s+[a-zA-Z]*/gi,
                /caffè\s+[a-zA-Z]*/gi,
                /biscotti\s+[a-zA-Z]*/gi,
                /[a-zA-Z]+\s+500g/gi,
                /[a-zA-Z]+\s+1kg/gi,
                /[a-zA-Z]+\s+1l/gi
            ];
            
            const supermarkets = ['conad', 'coop', 'esselunga', 'carrefour', 'lidl', 'md', 'eurospin', 'penny'];
            let detectedSupermarket = 'Altro';
            
            const textLower = text.toLowerCase();
            for (const market of supermarkets) {
                if (textLower.includes(market)) {
                    detectedSupermarket = market.charAt(0).toUpperCase() + market.slice(1);
                    break;
                }
            }
            
            for (let i = 0; i < lines.length; i++) {
                const line = lines[i].trim();
                const nextLine = i + 1 < lines.length ? lines[i + 1].trim() : '';
                const prevLine = i > 0 ? lines[i - 1].trim() : '';
                
                const priceMatches = [...line.matchAll(pricePattern)];
                
                if (priceMatches.length > 0) {
                    let productName = '';
                    const searchText = (prevLine + ' ' + line + ' ' + nextLine).toLowerCase();
                    
                    for (const pattern of productPatterns) {
                        const match = searchText.match(pattern);
                        if (match) {
                            productName = match[0].trim();
                            break;
                        }
                    }
                    
                    if (!productName) {
                        const words = line.split(/\s+/).filter(word => 
                            word.length > 3 && 
                            !/^\d+[,.]?\d*€?$/.test(word) && 
                            !/^\d+%$/.test(word)
                        );
                        
                        if (words.length > 0) {
                            productName = words.slice(0, 3).join(' ');
                        }
                    }
                    
                    if (productName) {
                        for (const priceMatch of priceMatches) {
                            const price = parseFloat(priceMatch[1] + '.' + priceMatch[2]);
                            
                            const percentMatch = line.match(percentPattern);
                            const discount = percentMatch ? percentMatch[1] + '%' : '';
                            
                            offers.push({
                                name: productName.charAt(0).toUpperCase() + productName.slice(1),
                                price: price,
                                originalPrice: discount ? price / (1 - parseInt(percentMatch[1]) / 100) : price + 0.5,
                                supermarket: detectedSupermarket,
                                discount: discount,
                                confidence: 0.7 + Math.random() * 0.2,
                                extractedText: `OCR: "${line}"`,
                                source: 'OCR'
                            });
                        }
                    }
                }
            }
            
            const uniqueOffers = [];
            for (const offer of offers) {
                const isDuplicate = uniqueOffers.some(existing => 
                    existing.name.toLowerCase().includes(offer.name.toLowerCase().split(' ')[0]) ||
                    offer.name.toLowerCase().includes(existing.name.toLowerCase().split(' ')[0])
                );
                
                if (!isDuplicate && offer.price > 0 && offer.price < 100) {
                    uniqueOffers.push(offer);
                }
            }
            
            return uniqueOffers.slice(0, 8);
        }

        function clearFlyerPreview() {
            document.getElementById('flyerPreview').style.display = 'none';
            document.getElementById('flyerResults').style.display = 'none';
            document.getElementById('ocrTextDisplay').style.display = 'none';
            document.getElementById('ocrProgress').classList.remove('show');
            currentFlyerImage = null;
            extractedOffers = [];
        }

        function displayExtractedOffers(offers) {
            extractedOffers = offers;
            const container = document.getElementById('extractedOffers');
            container.innerHTML = '';
            
            offers.forEach((offer, index) => {
                const savings = offer.originalPrice - offer.price;
                const confidenceClass = offer.confidence > 0.8 ? 'confidence-high' : offer.confidence > 0.6 ? 'confidence-medium' : 'confidence-low';
                const confidenceColor = offer.confidence > 0.8 ? '#27ae60' : offer.confidence > 0.6 ? '#f39c12' : '#e74c3c';
                
                const offerCard = document.createElement('div');
                offerCard.className = `product-card ${confidenceClass}`;
                offerCard.style.background = `linear-gradient(135deg, rgba(39, 174, 96, 0.1), rgba(46, 204, 113, 0.05))`;
                offerCard.style.borderLeft = `4px solid ${confidenceColor}`;
                
                offerCard.innerHTML = `
                    <div class="product-name">${offer.name}</div>
                    <div class="product-details">
                        <div>
                            ${offer.originalPrice > offer.price ? 
                                `<span style="text-decoration: line-through; color: #999; font-size: 0.9em;">€${offer.originalPrice.toFixed(2)}</span>` : ''
                            }
                            <span class="price" style="color: #27ae60; ${offer.originalPrice > offer.price ? 'margin-left: 10px;' : ''}">€${offer.price.toFixed(2)}</span>
                        </div>
                        <div class="supermarket">${offer.supermarket}</div>
                    </div>
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 10px;">
                        ${savings > 0 ? `<div class="savings">Risparmi €${savings.toFixed(2)} ${offer.discount ? '(' + offer.discount + ')' : ''}</div>` : ''}
                        <div style="font-size: 0.8em; color: #666;">
                            OCR: ${(offer.confidence * 100).toFixed(0)}%
                        </div>
                    </div>
                    <div style="font-size: 0.7em; color: #888; margin-top: 5px; font-style: italic;">
                        ${offer.extractedText}
                    </div>
                    <div style="text-align: center; margin-top: 15px;">
                        <button class="btn" onclick="addSingleExtractedOffer(${index})" style="background: linear-gradient(45deg, #27ae60, #2ecc71); margin-right: 5px; padding: 8px 15px; font-size: 0.9em;">
                            ✅ Aggiungi
                        </button>
                        <button class="btn" onclick="editExtractedOffer(${index})" style="background: linear-gradient(45deg, #3498db, #2980b9); margin-right: 5px; padding: 8px 15px; font-size: 0.9em;">
                            ✏️ Modifica
                        </button>
                        <button class="btn" onclick="removeExtractedOffer(${index})" style="background: linear-gradient(45deg, #e74c3c, #c0392b); padding: 8px 15px; font-size: 0.9em;">
                            ❌ Rimuovi
                        </button>
                    </div>
                    <div class="edit-form" id="editForm${index}" style="display: none; background: rgba(52, 152, 219, 0.05); padding: 15px; border-radius: 10px; margin-top: 15px; border: 1px solid #3498db;">
                        <input type="text" placeholder="Nome prodotto" value="${offer.name}" id="editName${index}" style="width: 100%; padding: 8px 12px; margin: 5px 0; border: 1px solid #ddd; border-radius: 5px;">
                        <input type="number" placeholder="Prezzo offerta" value="${offer.price}" step="0.01" id="editPrice${index}" style="width: 100%; padding: 8px 12px; margin: 5px 0; border: 1px solid #ddd; border-radius: 5px;">
                        <select id="editSupermarket${index}" style="width: 100%; padding: 8px 12px; margin: 5px 0; border: 1px solid #ddd; border-radius: 5px;">
                            <option value="Conad" ${offer.supermarket === 'Conad' ? 'selected' : ''}>Conad</option>
                            <option value="Coop" ${offer.supermarket === 'Coop' ? 'selected' : ''}>Coop</option>
                            <option value="Esselunga" ${offer.supermarket === 'Esselunga' ? 'selected' : ''}>Esselunga</option>
                            <option value="Carrefour" ${offer.supermarket === 'Carrefour' ? 'selected' : ''}>Carrefour</option>
                            <option value="Lidl" ${offer.supermarket === 'Lidl' ? 'selected' : ''}>Lidl</option>
                            <option value="MD" ${offer.supermarket === 'MD' ? 'selected' : ''}>MD</option>
                            <option value="Eurospin" ${offer.supermarket === 'Eurospin' ? 'selected' : ''}>Eurospin</option>
                            <option value="Penny" ${offer.supermarket === 'Penny' ? 'selected' : ''}>Penny</option>
                            <option value="Altro" ${offer.supermarket === 'Altro' ? 'selected' : ''}>Altro</option>
                        </select>
                        <div style="text-align: center; margin-top: 10px;">
                            <button class="btn" onclick="saveEditedOffer(${index})" style="background: linear-gradient(45deg, #27ae60, #2ecc71); margin-right: 10px; padding: 8px 15px; font-size: 0.9em;">
                                💾 Salva
                            </button>
                            <button class="btn" onclick="cancelEdit(${index})" style="background: linear-gradient(45deg, #95a5a6, #7f8c8d); padding: 8px 15px; font-size: 0.9em;">
                                ❌ Annulla
                            </button>
                        </div>
                    </div>
                `;
                
                container.appendChild(offerCard);
            });
            
            document.getElementById('flyerResults').style.display = 'block';
            showNotification(`🎯 Trovate ${offers.length} offerte dall'OCR!`, 'success');
        }

        function editExtractedOffer(index) {
            const editForm = document.getElementById(`editForm${index}`);
            editForm.style.display = editForm.style.display === 'none' ? 'block' : 'none';
        }

        function cancelEdit(index) {
            document.getElementById(`editForm${index}`).style.display = 'none';
        }

        function saveEditedOffer(index) {
            const newName = document.getElementById(`editName${index}`).value.trim();
            const newPrice = parseFloat(document.getElementById(`editPrice${index}`).value);
            const newSupermarket = document.getElementById(`editSupermarket${index}`).value;
            
            if (!newName || !newPrice || !newSupermarket) {
                showNotification('⚠️ Compila tutti i campi!', 'warning');
                return;
            }
            
            extractedOffers[index].name = newName;
            extractedOffers[index].price = newPrice;
            extractedOffers[index].supermarket = newSupermarket;
            
            displayExtractedOffers(extractedOffers);
            showNotification('✅ Offerta modificata!', 'success');
        }

        function removeExtractedOffer(index) {
            extractedOffers.splice(index, 1);
            displayExtractedOffers(extractedOffers);
            showNotification('🗑️ Offerta rimossa', 'info');
            
            if (extractedOffers.length === 0) {
                document.getElementById('flyerResults').style.display = 'none';
            }
        }

        function addSingleExtractedOffer(index) {
            const offer = extractedOffers[index];
            if (!offer) return;
            
            const existingProductIndex = products.findIndex(p => 
                p.name.toLowerCase().includes(offer.name.toLowerCase().split(' ')[0]) ||
                offer.name.toLowerCase().includes(p.name.toLowerCase().split(' ')[0])
            );
            
            if (existingProductIndex !== -1) {
                const existingProduct = products[existingProductIndex];
                const newOffer = { 
                    price: offer.price, 
                    supermarket: offer.supermarket, 
                    date: new Date(),
                    fromOCR: true,
                    ocrConfidence: offer.confidence
                };
                
                if (!existingProduct.offers) {
                    existingProduct.offers = [{ 
                        price: existingProduct.price, 
                        supermarket: existingProduct.supermarket, 
                        date: existingProduct.date || new Date()
                    }];
                    delete existingProduct.price;
                    delete existingProduct.supermarket;
                    delete existingProduct.date;
                }
                
                existingProduct.offers.push(newOffer);
            } else {
                products.push({
                    id: Date.now() + index,
                    name: offer.name,
                    offers: [{ 
                        price: offer.price, 
                        supermarket: offer.supermarket, 
                        date: new Date(),
                        fromOCR: true,
                        ocrConfidence: offer.confidence
                    }]
                });
            }
            
            extractedOffers.splice(index, 1);
            displayExtractedOffers(extractedOffers);
            
            renderProducts();
            updateStats();
            updateCharts();
            saveToLocalStorage();
            
            showNotification('✅ Offerta OCR aggiunta!', 'success');
            
            if (extractedOffers.length === 0) {
                document.getElementById('flyerResults').style.display = 'none';
                showNotification('🎉 Tutte le offerte OCR processate!', 'success');
            }
        }

        function addAllExtractedOffers() {
            if (extractedOffers.length === 0) return;
            
            const confirmMsg = `Aggiungere tutte le ${extractedOffers.length} offerte estratte dall'OCR?`;
            if (!confirm(confirmMsg)) return;
            
            let addedCount = 0;
            
            extractedOffers.forEach((offer, index) => {
                const existingProductIndex = products.findIndex(p => 
                    p.name.toLowerCase().includes(offer.name.toLowerCase().split(' ')[0]) ||
                    offer.name.toLowerCase().includes(p.name.toLowerCase().split(' ')[0])
                );
                
                if (existingProductIndex !== -1) {
                    const existingProduct = products[existingProductIndex];
                    const newOffer = { 
                        price: offer.price, 
                        supermarket: offer.supermarket, 
                        date: new Date(),
                        fromOCR: true,
                        ocrConfidence: offer.confidence
                    };
                    
                    if (!existingProduct.offers) {
                        existingProduct.offers = [{ 
                            price: existingProduct.price || offer.price, 
                            supermarket: existingProduct.supermarket || offer.supermarket, 
                            date: existingProduct.date || new Date()
                        }];
                        delete existingProduct.price;
                        delete existingProduct.supermarket;
                        delete existingProduct.date;
                    }
                    
                    existingProduct.offers.push(newOffer);
                } else {
                    products.push({
                        id: Date.now() + index,
                        name: offer.name,
                        offers: [{ 
                            price: offer.price, 
                            supermarket: offer.supermarket, 
                            date: new Date(),
                            fromOCR: true,
                            ocrConfidence: offer.confidence
                        }]
                    });
                }
                
                addedCount++;
            });
            
            extractedOffers = [];
            document.getElementById('flyerResults').style.display = 'none';
            
            renderProducts();
            updateStats();
            updateCharts();
            saveToLocalStorage();
            
            showNotification(`🎉 ${addedCount} offerte OCR aggiunte con successo!`, 'success');
        }

        // ====================== SCANNER BARCODE MIGLIORATO ======================
        function toggleScanner() {
            if (isScanning) {
                stopScanner();
            } else {
                startScanner();
            }
        }

        function startScanner() {
            const container = document.getElementById('scannerContainer');
            container.classList.add('active');
            isScanning = true;
            
            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                showNotification('❌ Camera non supportata su questo dispositivo', 'warning');
                stopScanner();
                return;
            }

            if (location.protocol !== 'https:' && location.hostname !== 'localhost' && location.hostname !== '127.0.0.1') {
                showNotification('⚠️ Lo scanner funziona meglio su HTTPS', 'warning');
            }

            navigator.mediaDevices.getUserMedia({ 
                video: { 
                    facingMode: "environment",
                    width: { ideal: 1280 },
                    height: { ideal: 720 }
                } 
            })
                .then(stream => {
                    stream.getTracks().forEach(track => track.stop());

                    Quagga.init({
                        inputStream: {
                            name: "Live",
                            type: "LiveStream",
                            target: document.querySelector('#scanner-preview'),
                            constraints: {
                                width: 640,
                                height: 480,
                                facingMode: "environment"
                            }
                        },
                        locator: {
                            patchSize: "medium",
                            halfSample: true
                        },
                        numOfWorkers: navigator.hardwareConcurrency || 4,
                        frequency: 10,
                        decoder: {
                            readers: [
                                "code_128_reader",
                                "ean_reader",
                                "ean_8_reader",
                                "code_39_reader",
                                "code_93_reader",
                                "codabar_reader"
                            ]
                        },
                        locate: true
                    }, function(err) {
                        if (err) {
                            console.error('Errore Quagga:', err);
                            showNotification('❌ Errore inizializzazione scanner', 'warning');
                            stopScanner();
                            return;
                        }

                        Quagga.start();
                        showNotification('📷 Scanner attivo - API OpenFoodFacts integrata!', 'info');
                    });

                    Quagga.onDetected(onBarcodeDetected);
                })
                .catch(err => {
                    console.error('Errore accesso camera:', err);
                    let errorMsg = '❌ Impossibile accedere alla camera';
                    if (err.name === 'NotAllowedError') {
                        errorMsg = '❌ Permesso camera negato - Controlla le impostazioni del browser';
                    } else if (err.name === 'NotFoundError') {
                        errorMsg = '❌ Nessuna camera trovata su questo dispositivo';
                    }
                    showNotification(errorMsg, 'warning');
                    stopScanner();
                });
        }

        function stopScanner() {
            const container = document.getElementById('scannerContainer');
            container.classList.remove('active');
            isScanning = false;
            
            if (typeof Quagga !== 'undefined') {
                Quagga.stop();
                Quagga.offDetected(onBarcodeDetected);
            }
            
            showNot20px; padding: 15px; background: rgba(39, 174, 96, 0.1); border-radius: 10px; border-left: 4px solid #27ae60;">
                            <strong>✅ Fonti Ufficiali Consigliate:</strong><br>
                            • <a href="https://www.doveconviene.it/iper-e-super" target="_blank" style="color: #3498db; text-decoration: none;">DoveConviene</a> - Il più completo in Italia<br>
                            • <a href="https://www.promoqui.it/offerte/iper-supermercati" target="_blank" style="color: #3498db; text-decoration: none;">PromoQui</a> - Ottima alternativa<br>
                            • <a href="https://www.volantinofacile.it/volantini-iper-supermercati" target="_blank" style="color: #3498db; text-decoration: none;">VolantinoFacile</a> - Facile navigazione<br>
                            • <a href="https://www.centrovolantini.it/volantini" target="_blank" style="color: #3498db; text-decoration: none;">CentroVolantini</a> - Oltre 300 volantini
                        </div>
                        
                        <div style="margin-bottom: 20px; padding: 15px; background: rgba(52, 152, 219, 0.1); border-radius: 10px; border-left: 4px solid #3498db;">
                            <strong>📱 App Consigliate:</strong><br>
                            • DoveConviene (iOS/Android) - La più usata in Italia<br>
                            • PromoQui (iOS/Android) - Con motore di ricerca offerte<br>
                            • App ufficiali: Esselunga, Conad, Carrefour hanno le loro app
                        </div>
                        
                        <div style="margin-bottom: 20px; padding: 15px; background: rgba(241, 196, 15, 0.1); border-radius: 10px; border-left: 4px solid #f1c40f;">
                            <strong>💡 Come Usare OfferteMax:</strong><br>
                            1. Scarica volantini PDF dai siti sopra<br>
                            2. Fai screenshot delle offerte interessanti<br>
                            3. Usa l'OCR di OfferteMax per estrarre i dati<br>
                            4. Aggiungi manualmente le offerte che ti interessano<br>
                            5. Confronta i prezzi e risparmia!
                        </div>
                        
                        <div style="margin-bottom:
