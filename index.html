<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>OfferteMax v5.1 - All-in-One (PDF + OCR + Scanner)</title>
<meta name="theme-color" content="#667eea">
<meta name="description" content="Scanner barcode + OCR Volantini + PDF AI + API Supermercati">

<!-- LIBRERIE -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js"></script>
<script src='https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js'></script>
<!-- NUOVA LIBRERIA PDF -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>

<script>
  // Configurazione Worker PDF
  pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js';
</script>

<style>
/* STILI ORIGINALI */
* { margin: 0; padding: 0; box-sizing: border-box; }
body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 10px; margin: 0; }
.container { max-width: 1200px; margin: 0 auto; background: white; border-radius: 20px; box-shadow: 0 20px 40px rgba(0,0,0,0.1); overflow: hidden; }
.header { background: linear-gradient(45deg, #ff6b6b, #ee5a24); color: white; padding: 20px 15px; text-align: center; }
.header h1 { font-size: 2.2em; margin-bottom: 8px; font-weight: 700; }
.header p { font-size: 1em; opacity: 0.9; margin: 0; }
.main-content { padding: 15px; }
.section { margin-bottom: 25px; padding: 20px 15px; border-radius: 15px; background: linear-gradient(145deg, #f8f9fa, #e9ecef); box-shadow: 0 8px 25px rgba(0,0,0,0.05); }
.section h2 { color: #2c3e50; margin-bottom: 15px; font-size: 1.4em; display: flex; align-items: center; gap: 8px; }
.btn { background: linear-gradient(45deg, #667eea, #764ba2); color: white; border: none; padding: 15px 20px; border-radius: 12px; font-size: 16px; font-weight: 600; cursor: pointer; transition: all 0.3s ease; text-decoration: none; display: flex; align-items: center; justify-content: center; width: 100%; margin-bottom: 10px; min-height: 50px; }
.btn:hover { transform: translateY(-2px); box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3); }
.btn:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }
.btn-grid { display: grid; grid-template-columns: 1fr; gap: 12px; margin-bottom: 20px; }
.btn-grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 20px; }
.scanner-container { display: none; margin: 20px 0; border-radius: 15px; overflow: hidden; background: #000; position: relative; min-height: 250px; }
.scanner-container.active { display: block; }
#scanner-preview { width: 100%; height: 250px; object-fit: cover; }
.scanner-overlay { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 180px; height: 80px; border: 2px solid #27ae60; border-radius: 10px; box-shadow: 0 0 20px rgba(39, 174, 96, 0.5); }
.products-grid { display: grid; grid-template-columns: 1fr; gap: 15px; margin-top: 15px; }
.product-card { background: white; border-radius: 15px; padding: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.08); border-left: 4px solid #27ae60; transition: all 0.3s ease; }
.product-card:hover { transform: translateY(-2px); box-shadow: 0 15px 30px rgba(0,0,0,0.15); }
.form-row { display: grid; grid-template-columns: 1fr; gap: 12px; margin-top: 15px; }
.form-input { padding: 15px; border: 2px solid #ddd; border-radius: 12px; font-size: 16px; width: 100%; box-sizing: border-box; }
.info-box { margin: 15px 0; padding: 15px; background: rgba(52, 152, 219, 0.1); border-radius: 10px; border-left: 4px solid #3498db; font-size: 0.9em; }
.success-box { background: rgba(39, 174, 96, 0.1); border-left-color: #27ae60; }
.warning-box { background: rgba(243, 156, 18, 0.1); border-left-color: #f39c12; }
.notification { position: fixed; top: 20px; right: 20px; padding: 15px 20px; border-radius: 12px; z-index: 1001; box-shadow: 0 5px 25px rgba(0,0,0,0.3); max-width: 300px; font-size: 0.9em; animation: slideInRight 0.3s ease forwards; color: white; }
.notification.success { background: linear-gradient(45deg, #27ae60, #2ecc71); }
.notification.warning { background: linear-gradient(45deg, #f39c12, #e67e22); }
.notification.info { background: linear-gradient(45deg, #3498db, #2980b9); }
.notification.error { background: linear-gradient(45deg, #e74c3c, #c0392b); }
.stats-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 15px; margin: 20px 0; }
.stat-card { background: white; padding: 15px; border-radius: 10px; text-align: center; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
.stat-number { font-size: 2em; font-weight: 700; color: #27ae60; margin-bottom: 5px; }
.stat-label { font-size: 0.8em; color: #666; text-transform: uppercase; letter-spacing: 1px; }
@keyframes slideInRight { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
@keyframes slideOutRight { from { transform: translateX(0); opacity: 1; } to { transform: translateX(100%); opacity: 0; } }
@media (min-width: 768px) { .main-content { padding: 30px 20px; } .btn-grid { grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); } .form-row { grid-template-columns: 1fr 1fr; } }
</style>
</head>
<body>
<div class="container">
  <div class="header">
    <h1>üõí OfferteMax v5.1</h1>
    <p>Scanner + OCR + PDF Engine Integrato</p>
  </div>

  <div class="main-content">
    <!-- STATISTICHE RAPIDE -->
    <div class="stats-container">
      <div class="stat-card">
        <div class="stat-number" id="totalProducts">0</div>
        <div class="stat-label">Prodotti</div>
      </div>
      <div class="stat-card">
        <div class="stat-number" id="totalSavings">‚Ç¨0</div>
        <div class="stat-label">Risparmi</div>
      </div>
    </div>

    <!-- ========================================== -->
    <!-- NUOVA SEZIONE: ANALISI PDF (MOTORE GEOMETRICO) -->
    <!-- ========================================== -->
    <div class="section" style="border: 2px solid #9b59b6; background: linear-gradient(145deg, #f3e5f5, #ffffff);">
      <h2 style="color: #8e44ad;">üìÑ Analisi Volantino PDF (Nuovo)</h2>
      <div class="info-box">
        <strong>üöÄ Veloce e Preciso:</strong> Carica il file PDF scaricato (es. Lidl, Eurospin). Il sistema estrarr√† prodotti e prezzi automaticamente.
      </div>

      <div class="form-row">
          <input type="file" id="pdfFileInput" accept=".pdf" class="form-input" />
          <button id="analyzePdfBtn" class="btn" onclick="startPdfAnalysis()" style="background: linear-gradient(45deg, #9b59b6, #8e44ad); margin: 0;">
              üß† Analizza PDF
          </button>
      </div>

      <div id="pdfResultsArea" style="display: none; margin-top: 20px;">
          <h3>Risultati PDF:</h3>
          <div id="pdfOffersList" class="products-grid"></div>
          <button class="btn" onclick="addAllPdfOffers()" style="background: linear-gradient(45deg, #27ae60, #2ecc71); margin-top:15px;">
              ‚úÖ Aggiungi Tutte
          </button>
      </div>
    </div>
    <!-- ========================================== -->

    <!-- SEZIONE OCR VOLANTINI (IMMAGINI) -->
    <div class="section">
      <h2>üìñ OCR Volantini (Immagini)</h2>
      <div class="btn-grid">
        <label class="btn" style="background: linear-gradient(45deg, #3498db, #2980b9); cursor: pointer;">
          üì∑ Scatta Foto
          <input type="file" accept="image/*" capture="camera" onchange="processOCRFlyer(event)" style="display: none;">
        </label>
        <label class="btn" style="background: linear-gradient(45deg, #9b59b6, #8e44ad); cursor: pointer;">
          üñºÔ∏è Carica Immagine
          <input type="file" accept="image/*" onchange="processOCRFlyer(event)" style="display: none;">
        </label>
      </div>
      <div id="flyerPreview" style="display: none; margin: 20px 0; text-align: center;">
        <img id="flyerImage" style="max-width: 100%; max-height: 300px; border-radius: 10px;">
        <button class="btn" onclick="startOCRAnalysis()" id="analyzeOCRBtn" style="margin-top: 10px;">üîç Avvia OCR Immagine</button>
      </div>
      <div id="ocrProgress" style="display: none; padding: 15px;">Attendere...</div>
      <div id="flyerResults" style="display: none;">
          <div id="extractedOffers" class="products-grid"></div>
      </div>
    </div>

    <!-- SEZIONE SCANNER BARCODE -->
    <div class="section">
      <h2>üì± Scanner Barcode</h2>
      <button class="btn" onclick="toggleScanner()" style="background: linear-gradient(45deg, #27ae60, #2ecc71);">
        üì∑ Avvia Scanner
      </button>
      <div class="scanner-container" id="scannerContainer">
        <div id="scanner-preview"></div>
        <div class="scanner-overlay"></div>
        <button class="btn" onclick="stopScanner()" style="position: absolute; bottom: 10px; left: 50%; transform: translateX(-50%); width: auto; background: #e74c3c;">‚ùå Stop</button>
      </div>
      <div id="barcodeResult" style="display: none; background: #2ecc71; color: white; padding: 15px; border-radius: 10px; margin-top: 10px;">
          <strong id="barcodeName">Prodotto</strong>
          <button class="btn" onclick="useBarcodeResult()" style="margin-top:10px; background:rgba(255,255,255,0.2);">Usa</button>
      </div>

      <div class="form-row">
        <input type="text" id="productName" placeholder="Nome prodotto" class="form-input" />
        <input type="number" id="productPrice" placeholder="Prezzo ‚Ç¨" step="0.01" class="form-input" />
      </div>
      <div class="form-row">
        <select id="supermarketSelect" class="form-input">
          <option value="Generico">Seleziona Supermercato</option>
          <option value="Conad">Conad</option>
          <option value="Lidl">Lidl</option>
          <option value="Eurospin">Eurospin</option>
          <option value="Coop">Coop</option>
          <option value="Esselunga">Esselunga</option>
          <option value="Carrefour">Carrefour</option>
        </select>
        <button class="btn" onclick="addProduct()" style="background: linear-gradient(45deg, #27ae60, #2ecc71); margin: 0;">‚ûï Aggiungi</button>
      </div>
    </div>

    <!-- SEZIONE LISTA PRODOTTI -->
    <div class="section">
      <h2>üèÜ I Tuoi Prodotti</h2>
      <div id="productsContainer" class="products-grid">
          <p style="text-align: center; color: #777;">Nessun prodotto. Inizia scansionando!</p>
      </div>
    </div>

    <!-- SEZIONE CONTROLLI -->
    <div class="section">
      <h2>‚öôÔ∏è Gestione</h2>
      <button class="btn" onclick="clearAllData()" style="background: #e74c3c;">üóëÔ∏è Cancella Tutto</button>
    </div>

  </div>
</div>

<script>
// =================================================
// 1. GESTIONE DATI E STATISTICHE
// =================================================
let products = [];
let extractedOffers = []; // Per OCR Immagini
let pdfOffers = [];       // Per PDF

document.addEventListener('DOMContentLoaded', function() {
  loadData();
  renderProducts();
  updateStats();
});

function loadData() {
  const saved = localStorage.getItem('offertemax_data_v5');
  if (saved) {
    try { products = JSON.parse(saved); } catch(e) { products = []; }
  }
}

function saveData() {
  localStorage.setItem('offertemax_data_v5', JSON.stringify(products));
  updateStats();
}

function updateStats() {
  document.getElementById('totalProducts').innerText = products.length;
  let savings = 0; // Logica placeholder per risparmi
  products.forEach(p => { if(p.originalPrice > p.price) savings += (p.originalPrice - p.price); });
  document.getElementById('totalSavings').innerText = '‚Ç¨' + savings.toFixed(2);
}

function renderProducts() {
  const container = document.getElementById('productsContainer');
  container.innerHTML = '';
  if (products.length === 0) {
    container.innerHTML = '<p style="text-align: center; padding: 20px;">La lista √® vuota.</p>';
    return;
  }
  // Ordina: pi√π recenti prima
  products.slice().reverse().forEach((p, index) => {
    const div = document.createElement('div');
    div.className = 'product-card';
    div.innerHTML = `
      <div style="font-weight: bold; color: #2c3e50;">${p.name}</div>
      <div style="display: flex; justify-content: space-between; margin-top: 5px;">
          <span style="color: #27ae60; font-weight: bold; font-size: 1.2em;">‚Ç¨${parseFloat(p.price).toFixed(2)}</span>
          <span style="background: #eee; padding: 2px 8px; border-radius: 10px; font-size: 0.8em;">${p.supermarket}</span>
      </div>
      <button onclick="deleteProduct(${products.length - 1 - index})" style="background:none; border:none; color:red; margin-top:10px; cursor:pointer;">Elimina</button>
    `;
    container.appendChild(div);
  });
}

function addProduct() {
  const name = document.getElementById('productName').value;
  const price = document.getElementById('productPrice').value;
  const market = document.getElementById('supermarketSelect').value;

  if(!name || !price) { showNotification('Compila nome e prezzo!', 'warning'); return; }

  products.push({
    id: Date.now(),
    name: name,
    price: parseFloat(price),
    supermarket: market,
    date: new Date()
  });

  saveData();
  renderProducts();
  document.getElementById('productName').value = '';
  document.getElementById('productPrice').value = '';
  showNotification('Prodotto aggiunto!', 'success');
}

function deleteProduct(realIndex) {
  if(confirm('Eliminare?')) {
    products.splice(realIndex, 1);
    saveData();
    renderProducts();
  }
}

function clearAllData() {
  if(confirm('Cancelli tutto?')) {
    products = [];
    saveData();
    renderProducts();
    showNotification('Dati cancellati.', 'info');
  }
}

// =================================================
// 2. NUOVO MOTORE PDF GEOMETRICO (INTEGRATO)
// =================================================

async function startPdfAnalysis() {
    const fileInput = document.getElementById('pdfFileInput');
    const btn = document.getElementById('analyzePdfBtn');

    if (fileInput.files.length === 0) {
      showNotification("Seleziona prima un file PDF!", "error");
      return;
    }

    const file = fileInput.files[0];
    btn.disabled = true;
    btn.innerHTML = "‚è≥ Analisi Geometrica...";

    try {
      const arrayBuffer = await file.arrayBuffer();
      const pdfData = new Uint8Array(arrayBuffer);

      // 1. Estrazione Coordinate
      const items = await extractTextWithCoords(pdfData);
      // 2. Associazione Spaziale
      const offers = findNearestAssociations(items);

      // 3. Display
      displayPdfResults(offers);
      showNotification(`Trovate ${offers.length} offerte nel PDF!`, "success");

    } catch (e) {
      console.error(e);
      showNotification("Errore lettura PDF.", "error");
    } finally {
      btn.disabled = false;
      btn.innerHTML = "üß† Analizza PDF";
    }
}

async function extractTextWithCoords(pdfData) {
    const pdf = await pdfjsLib.getDocument({data: pdfData}).promise;
    let allItems = [];
    // Limitiamo a 5 pagine per performance
    const maxPages = Math.min(pdf.numPages, 5);

    for (let i = 1; i <= maxPages; i++) {
      const page = await pdf.getPage(i);
      const content = await page.getTextContent();
      const viewport = page.getViewport({scale: 1.0});

      content.items.forEach(item => {
        const str = item.str.trim();
        if(str.length < 2) return;
        allItems.push({
          text: str,
          x: item.transform[4],
          y: viewport.height - item.transform[5], // Invertiamo Y
          page: i
        });
      });
    }
    return allItems;
}

function findNearestAssociations(items) {
    const priceRegex = /‚Ç¨?\s*\d+[.,]\d{2}\s*‚Ç¨?/;
    const prices = items.filter(i => priceRegex.test(i.text) && i.text.length < 15);
    const products = items.filter(i => !priceRegex.test(i.text) && i.text.length > 3 && i.text.length < 60);
    const results = [];

    prices.forEach(p => {
      let bestMatch = null;
      let minDistance = 250; // Pixel distance threshold

      products.forEach(prod => {
        if (prod.page !== p.page) return;
        // Distanza Euclidea
        const dist = Math.sqrt(Math.pow(p.x - prod.x, 2) + Math.pow(p.y - prod.y, 2));
        if (dist < minDistance) {
          minDistance = dist;
          bestMatch = prod;
        }
      });

      if (bestMatch) {
        const cleanPrice = p.text.replace(/[^\d,.]/g, '').replace(',', '.');
        results.push({
          name: bestMatch.text,
          price: cleanPrice,
          supermarket: "Volantino PDF"
        });
      }
    });

    // Rimuovi duplicati esatti
    const uniqueMap = new Map();
    results.forEach(item => uniqueMap.set(item.name + item.price, item));
    return Array.from(uniqueMap.values());
}

function displayPdfResults(offers) {
    pdfOffers = offers; // Salva in var globale temporanea
    const list = document.getElementById('pdfOffersList');
    list.innerHTML = '';

    if(offers.length === 0) {
        list.innerHTML = '<p>Nessuna offerta rilevata.</p>';
        document.getElementById('pdfResultsArea').style.display = 'block';
        return;
    }

    offers.forEach((o, idx) => {
        const div = document.createElement('div');
        div.className = 'product-card';
        div.style.borderLeftColor = '#9b59b6';
        div.innerHTML = `
            <div style="font-weight:bold;">${o.name}</div>
            <div style="color:#9b59b6; font-weight:bold;">‚Ç¨${o.price}</div>
            <button onclick="addSinglePdfOffer(${idx})" class="btn" style="margin-top:5px; padding:5px; font-size:0.8em; background:#9b59b6;">+ Aggiungi</button>
        `;
        list.appendChild(div);
    });
    document.getElementById('pdfResultsArea').style.display = 'block';
}

function addSinglePdfOffer(idx) {
    const o = pdfOffers[idx];
    products.push({
        id: Date.now() + Math.random(),
        name: o.name,
        price: parseFloat(o.price),
        supermarket: "Volantino PDF",
        date: new Date()
    });
    saveData();
    renderProducts();
    showNotification("Aggiunto: " + o.name, "success");
    // Rimuovi visivamente
    pdfOffers.splice(idx, 1);
    displayPdfResults(pdfOffers);
}

function addAllPdfOffers() {
    pdfOffers.forEach(o => {
        products.push({
            id: Date.now() + Math.random(),
            name: o.name,
            price: parseFloat(o.price),
            supermarket: "Volantino PDF",
            date: new Date()
        });
    });
    pdfOffers = [];
    saveData();
    renderProducts();
    document.getElementById('pdfResultsArea').style.display = 'none';
    showNotification("Tutte le offerte PDF aggiunte!", "success");
}

// =================================================
// 3. VECCHIE FUNZIONI (Barcode e OCR Immagini)
// =================================================
// (Manteniamo le funzioni base per compatibilit√†)

let isScanning = false;
function toggleScanner() {
    if(isScanning) stopScanner();
    else startQuagga();
}

function startQuagga() {
    document.getElementById('scannerContainer').style.display = 'block';
    isScanning = true;
    Quagga.init({
        inputStream : { name : "Live", type : "LiveStream", target: document.querySelector('#scanner-preview') },
        decoder : { readers : ["ean_reader"] }
    }, function(err) {
        if (err) { console.log(err); return; }
        Quagga.start();
    });
    Quagga.onDetected(function(result) {
        const code = result.codeResult.code;
        document.getElementById('barcodeName').innerText = "Codice: " + code;
        document.getElementById('barcodeResult').style.display = 'block';
        stopScanner();
    });
}

function stopScanner() {
    Quagga.stop();
    isScanning = false;
    document.getElementById('scannerContainer').style.display = 'none';
}

function useBarcodeResult() {
    // Simulazione database
    document.getElementById('productName').value = "Prodotto " + document.getElementById('barcodeName').innerText;
    document.getElementById('barcodeResult').style.display = 'none';
}

// Funzione OCR Immagini (Semplificata dal tuo codice originale)
async function processOCRFlyer(event) {
    const file = event.target.files[0];
    if(!file) return;
    const reader = new FileReader();
    reader.onload = function(e) {
        document.getElementById('flyerImage').src = e.target.result;
        document.getElementById('flyerPreview').style.display = 'block';
    };
    reader.readAsDataURL(file);
}

async function startOCRAnalysis() {
    const img = document.getElementById('flyerImage');
    document.getElementById('ocrProgress').style.display = 'block';

    Tesseract.recognize(img.src, 'ita', { logger: m => console.log(m) })
    .then(({ data: { text } }) => {
        document.getElementById('ocrProgress').style.display = 'none';
        // Logica parsing testo (semplificata per demo)
        const lines = text.split('\n');
        extractedOffers = [];
        lines.forEach(line => {
            if(line.includes('‚Ç¨')) {
                extractedOffers.push({ name: line.replace(/[\d,‚Ç¨]/g, '').trim(), price: line.match(/[\d,]+/)[0], supermarket: "OCR Immagine" });
            }
        });
        displayExtractedOffers(extractedOffers);
    });
}

function displayExtractedOffers(offers) {
    const container = document.getElementById('extractedOffers');
    container.innerHTML = '';
    offers.forEach(o => {
        container.innerHTML += `<div class="product-card" style="border-left-color:blue;">
            <b>${o.name}</b> - ‚Ç¨${o.price}
            <button class="btn" style="margin-top:5px; padding:5px; font-size:0.8em;" onclick="addProductFromOCR('${o.name}', '${o.price}')">+ Aggiungi</button>
        </div>`;
    });
    document.getElementById('flyerResults').style.display = 'block';
}

function addProductFromOCR(name, price) {
    products.push({ id: Date.now(), name: name, price: parseFloat(price.replace(',','.')), supermarket: "OCR Immagine", date: new Date() });
    saveData();
    renderProducts();
    showNotification("Offerta OCR aggiunta!", "success");
}

function showNotification(msg, type) {
    const n = document.createElement('div');
    n.className = `notification ${type}`;
    n.innerText = msg;
    document.body.appendChild(n);
    setTimeout(() => n.remove(), 3000);
}
</script>
</body>
</html>
